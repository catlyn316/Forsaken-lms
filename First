local update = "Roblox 全能控制器(修改版 v1.4 - forsaken專用)已載入"
local update2 = "更新：移除自動反繞 只保留防反繞 優化碰壁檢測"

local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local PathfindingService = game:GetService("PathfindingService")
local TweenService = game:GetService("TweenService")

-- 防止重複執行
if CoreGui:FindFirstChild("SpeedJumpController") then CoreGui.SpeedJumpController:Destroy() end
if playerGui:FindFirstChild("SpeedJumpController") then playerGui.SpeedJumpController:Destroy() end
if CoreGui:FindFirstChild("ShiftLockUI") then CoreGui.ShiftLockUI:Destroy() end
if playerGui:FindFirstChild("ShiftLockUI") then playerGui.ShiftLockUI:Destroy() end

-- ShiftLock 系統變數（新版）
local shiftLockEnabled = false
local shiftLockConnection = nil
local shiftLockUI = nil
local lockMode = "none"  -- "none", "shiftlock", "nearest", "click"
local lockRotCon = nil
local lockTargetPlayer = nil
local lockMouseClickConn = nil
local lastLockMode = "none"  -- 記錄防反繞啟動前的鎖定模式
local lastClickTime = 0
local lastClickedPlayer = nil

-- ====================
-- 核心變數與備份
-- ====================

-- 鎖定最原始的光照設定
local trueLightingBackup = {
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    Brightness = Lighting.Brightness,
    ColorShift_Bottom = Lighting.ColorShift_Bottom,
    ColorShift_Top = Lighting.ColorShift_Top,
    FogEnd = Lighting.FogEnd
}

-- 初始角色數值
local originalSpeed = 16
local hasOriginalValues = false

-- 功能狀態開關
local toggles = {
    speed = false,
    fullbright = false,
    cameraDist = false,
    nofog = false,
    noFilter = false,
    counterEvade = false,  -- 改名為 counterEvade
    generatorESP = false,
    itemESP = false,
    autoInvisible = false,
    counterEvadeMode = "disguise"  -- "disguise" 或 "fullpower"
}

-- 數值設定
local values = {
    speed = 34,
    fullbright = 1,
    cameraDist = 80,
    evadeRange = 15,
    evadeSpeed = 30
}

-- 連線儲存
local connections = {
    speed = nil,
    fullbright = nil,
    nofog = nil,
    noFilter = nil,
    counterEvade = nil,  -- 改名
    generatorESP = nil,
    itemESP = nil,
    autoInvisible = nil
}

-- ESP 顯示緩存
local espObjects = {
    generators = {},
    items = {}
}

-- 防反繞系統變數
local isCounterEvading = false
local lastCounterEvadeTime = 0
local counterEvadeCooldown = 1
local lockedTarget = nil
local targetLockStartTime = 0

-- ====================
-- ShiftLock 系統（新版 - 包含多種鎖定模式）
-- ====================

-- 清除所有鎖定模式
local function clearAllLockModes()
    if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
    if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum.AutoRotate = true end
    end
    
    lockMode = "none"
    shiftLockEnabled = false
    lockTargetPlayer = nil
    lastClickedPlayer = nil
end

-- 設置面向旋轉
local function setFaceRotation(type, target)
    if lockRotCon then lockRotCon:Disconnect() end
    
    local char = player.Character
    if not char then return end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    
    hum.AutoRotate = false
    
    lockRotCon = RunService.RenderStepped:Connect(function()
        local myChar = player.Character
        if not myChar then return end
        
        local myHRP = myChar:FindFirstChild("HumanoidRootPart")
        if not myHRP then return end
        
        local lookAtPos = nil
        
        if type == "nearest" then
            local nearest, minDist = nil, math.huge
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    local pRoot = p.Character.HumanoidRootPart
                    local d = (myHRP.Position - pRoot.Position).Magnitude
                    if d < minDist then minDist = d; nearest = pRoot end
                end
            end
            if nearest then lookAtPos = nearest.Position end
            
        elseif type == "click" and target and target.Character then
            local pRoot = target.Character:FindFirstChild("HumanoidRootPart")
            if pRoot then lookAtPos = pRoot.Position end
            
        elseif type == "shiftlock" then
            local cam = Workspace.CurrentCamera
            if cam then
                local lv = cam.CFrame.LookVector
                lookAtPos = myHRP.Position + Vector3.new(lv.X, 0, lv.Z)
            end
        end
        
        if lookAtPos then
            local flatDir = (lookAtPos - myHRP.Position) * Vector3.new(1, 0, 1)
            if flatDir.Magnitude > 0.001 then
                myHRP.CFrame = CFrame.lookAt(myHRP.Position, myHRP.Position + flatDir.Unit, Vector3.yAxis)
            end
        end
    end)
end

-- 啟用 ShiftLock
local function enableShiftLock()
    if lockMode == "shiftlock" then return end
    
    clearAllLockModes()
    lockMode = "shiftlock"
    shiftLockEnabled = true
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
    end
    
    setFaceRotation("shiftlock")
end

-- 禁用所有鎖定（僅供防反繞使用）
local function disableAllLocksForCounterEvade()
    lastLockMode = lockMode  -- 記錄當前模式
    if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
    if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum.AutoRotate = true end
    end
end

-- 恢復防反繞前的鎖定模式
local function restoreLockMode()
    if lastLockMode == "none" then
        return
    end
    
    task.wait(0.1)
    
    if lastLockMode == "shiftlock" then
        lockMode = "shiftlock"
        shiftLockEnabled = true
        if UserInputService.MouseEnabled then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        end
        setFaceRotation("shiftlock")
        
    elseif lastLockMode == "nearest" then
        lockMode = "nearest"
        setFaceRotation("nearest")
        
    elseif lastLockMode == "click" and lockTargetPlayer then
        lockMode = "click"
        setFaceRotation("click", lockTargetPlayer)
    end
end

-- ====================
-- 核心邏輯函數
-- ====================

-- 獲取初始值
local function getOriginalValues()
    if toggles.speed then return end
    
    local character = player.Character
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            originalSpeed = humanoid.WalkSpeed
        end
    end
    hasOriginalValues = true
end

-- 智能光照管理器
local function updateLighting()
    if toggles.fullbright then
        if connections.fullbright then connections.fullbright:Disconnect() end
        
        connections.fullbright = RunService.RenderStepped:Connect(function()
            local ambientValue = math.min(values.fullbright, 99)
            Lighting.Ambient = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.Brightness = values.fullbright
            Lighting.ColorShift_Bottom = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.ColorShift_Top = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.OutdoorAmbient = Color3.new(ambientValue, ambientValue, ambientValue)
        end)
    else
        if connections.fullbright then connections.fullbright:Disconnect() end
        
        Lighting.Ambient = trueLightingBackup.Ambient
        Lighting.Brightness = trueLightingBackup.Brightness
        Lighting.OutdoorAmbient = trueLightingBackup.OutdoorAmbient
        Lighting.ColorShift_Bottom = trueLightingBackup.ColorShift_Bottom
        Lighting.ColorShift_Top = trueLightingBackup.ColorShift_Top
    end
end

-- 應用速度
local function applySpeed(char)
    if not char then char = player.Character end
    if not char then return end
    local hum = char:WaitForChild("Humanoid", 10)
    if not hum then return end

    if connections.speed then connections.speed:Disconnect() end
    
    if toggles.speed then
        hum.WalkSpeed = values.speed
        connections.speed = hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
            if toggles.speed then hum.WalkSpeed = values.speed end
        end)
    else
        hum.WalkSpeed = originalSpeed
    end
end

-- ====================
-- 防反繞系統（殺手模式）- 簡化版
-- ====================

-- 尋找最近玩家函數（支援鎖定）
local function findNearestPlayer()
    local char = player.Character
    if not char then return nil, math.huge end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, math.huge end
    
    -- 如果有鎖定的目標，且鎖定時間未超過 3 秒，繼續追擊該目標
    local currentTime = tick()
    if lockedTarget and (currentTime - targetLockStartTime) < 3 then
        if lockedTarget.Character then
            local targetHRP = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            if targetHRP then
                local distance = (hrp.Position - targetHRP.Position).Magnitude
                return lockedTarget, distance
            end
        end
    end
    
    -- 如果沒有鎖定目標，或鎖定時間已過，尋找新的最近玩家
    local nearestPlayer = nil
    local minDistance = math.huge
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local otherHRP = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherHRP then
                local distance = (hrp.Position - otherHRP.Position).Magnitude
                if distance < minDistance then
                    minDistance = distance
                    nearestPlayer = otherPlayer
                end
            end
        end
    end
    
    -- 如果找到新目標，鎖定它
    if nearestPlayer then
        lockedTarget = nearestPlayer
        targetLockStartTime = currentTime
    end
    
    return nearestPlayer, minDistance
end

-- 執行防反繞動作（殺手追擊玩家）
local function performCounterEvade()
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    local targetPlayer, distance = findNearestPlayer()
    if not targetPlayer then return end
    if distance > values.evadeRange then return end
    
    -- 檢查是否有障礙物阻擋
    local targetHRP = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {char, targetPlayer.Character}
    
    local directionToTarget = targetHRP.Position - hrp.Position
    local rayResult = Workspace:Raycast(hrp.Position, directionToTarget, params)
    
    if rayResult then
        return  -- 檢測到障礙物，暫停追擊（不進冷卻）
    end
    
    -- 檢查冷卻時間
    local currentTime = tick()
    if toggles.counterEvadeMode == "disguise" then
        if currentTime - lastCounterEvadeTime < 5 then return end
    end
    
    isCounterEvading = true
    lastCounterEvadeTime = currentTime
    
    -- 【新增】禁用所有鎖定功能（保留 ESP）
    disableAllLocksForCounterEvade()
    
    -- 保存原始速度
    local originalWalkSpeed = humanoid.WalkSpeed
    local wasSpeedActive = toggles.speed
    
    -- 如果速度功能開啟，先關閉它
    if toggles.speed then
        toggles.speed = false
        if connections.speed then connections.speed:Disconnect() end
        humanoid.WalkSpeed = originalSpeed
    end
    
    task.spawn(function()
        local targetHRP = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then
            isCounterEvading = false
            -- 【新增】恢復鎖定
            restoreLockMode()
            return
        end
        
        -- 使用 BodyVelocity 控制移動
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(100000, 0, 100000)
        bodyVelocity.P = 10000
        bodyVelocity.Parent = hrp
        
        humanoid.AutoRotate = false
        
        local duration = toggles.counterEvadeMode == "disguise" and 3 or 1
        local steps = math.ceil(duration / 0.03)

        -- 偽裝模式: 監控速度是否被設為小於5
        local isDisguiseMode = toggles.counterEvadeMode == "disguise"
        
        -- 改進的碰壁檢測變數
        local lastPosition = hrp.Position
        local stuckCheckInterval = 0.2
        local lastCheckTime = tick()
        local forwardMoveThreshold = 5  -- 前方移動距離閾值
        local consecutiveStuckCount = 0
        local maxStuckCount = 3
        
        -- 改進的目標掛機檢測
        local lastTargetPosition = targetHRP.Position
        local targetStuckCount = 0
        local maxTargetStuckCount = 8  -- 增加到8次才判定為掛機
        local targetMoveThreshold = 2  -- 目標移動距離閾值增加到2
        local targetCirclingDetection = {}  -- 繞圈檢測
        local circlingCheckCount = 0
        
        for i = 1, steps do
            if not isCounterEvading or not toggles.counterEvade then
                break
            end
            
            -- 偽裝模式: 檢查速度是否小於5
            if isDisguiseMode and humanoid.WalkSpeed < 5 then
                lastCounterEvadeTime = tick()  -- 立即進入冷卻(5秒)
                break
            end
            
            -- 改進的碰壁檢測：檢測前方是否有障礙物 + 前方移動距離
            local currentTime = tick()
            if currentTime - lastCheckTime >= stuckCheckInterval then
                -- 計算面向方向的移動距離
                local moveVector = hrp.Position - lastPosition
                local lookDirection = hrp.CFrame.LookVector
                local forwardMovement = moveVector:Dot(lookDirection)  -- 前方移動分量
                
                -- 檢測前方是否有障礙物
                local rayParams = RaycastParams.new()
                rayParams.FilterType = Enum.RaycastFilterType.Blacklist
                rayParams.FilterDescendantsInstances = {char, targetPlayer.Character}
                
                local forwardRay = Workspace:Raycast(hrp.Position, lookDirection * 10, rayParams)
                local hasObstacleAhead = forwardRay ~= nil and forwardRay.Distance < 5
                
                -- 如果前方有障礙物 且 前方移動距離小於5
                if hasObstacleAhead and forwardMovement < forwardMoveThreshold then
                    consecutiveStuckCount = consecutiveStuckCount + 1
                    if consecutiveStuckCount >= maxStuckCount then
                        -- 玩家碰壁，暫停防反繞
                        break
                    end
                else
                    consecutiveStuckCount = 0
                end
                
                -- 改進的目標掛機檢測
                local targetDistanceMoved = (targetHRP.Position - lastTargetPosition).Magnitude
                
                if targetDistanceMoved < targetMoveThreshold then
                    targetStuckCount = targetStuckCount + 1
                    
                    -- 同時檢測是否在繞圈（玩家和目標距離變化很小）
                    local currentDistance = (hrp.Position - targetHRP.Position).Magnitude
                    table.insert(targetCirclingDetection, currentDistance)
                    
                    if #targetCirclingDetection > 5 then
                        table.remove(targetCirclingDetection, 1)
                        
                        -- 計算距離變化
                        local minDist = math.huge
                        local maxDist = -math.huge
                        for _, dist in ipairs(targetCirclingDetection) do
                            minDist = math.min(minDist, dist)
                            maxDist = math.max(maxDist, dist)
                        end
                        
                        -- 如果距離變化小於3（在繞圈）
                        if (maxDist - minDist) < 3 then
                            circlingCheckCount = circlingCheckCount + 1
                            if circlingCheckCount >= 3 then
                                -- 檢測到繞圈，暫停防反繞
                                break
                            end
                        else
                            circlingCheckCount = 0
                        end
                    end
                    
                    -- 如果目標長時間不動
                    if targetStuckCount >= maxTargetStuckCount then
                        -- 目標掛機，暫停防反繞
                        break
                    end
                else
                    targetStuckCount = 0
                    circlingCheckCount = 0
                    targetCirclingDetection = {}
                end
                
                lastPosition = hrp.Position
                lastTargetPosition = targetHRP.Position
                lastCheckTime = currentTime
            end

            -- 持續追擊鎖定的目標
            if lockedTarget and lockedTarget.Character then
                targetHRP = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            end
            
            if not targetHRP then break end
            
            -- 計算方向
            local direction = (targetHRP.Position - hrp.Position).Unit
            bodyVelocity.Velocity = direction * values.evadeSpeed
            
            -- 面向目標
            local lookDirection = direction * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        -- 清理
        bodyVelocity:Destroy()
        humanoid.AutoRotate = true
        
        -- 恢復速度設置
        if wasSpeedActive then
            toggles.speed = true
            applySpeed()
        else
            humanoid.WalkSpeed = originalSpeed
        end
        
        -- 【新增】恢復鎖定功能
        restoreLockMode()
        
        isCounterEvading = false
    end)
end

-- 防反繞監控
local function startCounterEvade()
    if connections.counterEvade then connections.counterEvade:Disconnect() end
    
    if toggles.counterEvade then
        connections.counterEvade = RunService.Heartbeat:Connect(function()
            if not isCounterEvading then
                performCounterEvade()
            end
        end)
    else
        if connections.counterEvade then
            connections.counterEvade:Disconnect()
            connections.counterEvade = nil
        end
    end
end

-- ====================
-- ESP 顯示系統
-- ====================

-- 創建 ESP 高亮框
local function createESPBox(part, color, itemType)
    -- 創建 BoxHandleAdornment
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "ESPBox"
    box.Adornee = part
    box.Size = part.Size
    box.Color3 = color
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Transparency = 0.7
    box.Parent = part
    
    -- 創建 BillboardGui 顯示距離和進度
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPLabel"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 100, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = color
    label.TextStrokeTransparency = 0.5
    label.TextSize = 14
    label.Font = Enum.Font.GothamBold
    label.Parent = billboard
    
    -- 更新距離和進度顯示
    local updateConnection
    updateConnection = RunService.RenderStepped:Connect(function()
        if not part or not part.Parent then
            updateConnection:Disconnect()
            return
        end
        
        local char = player.Character
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                local distance = (part.Position - hrp.Position).Magnitude
                
                -- 如果是發電機，顯示進度
                if itemType == "generator" then
                    local mainParent = part.Parent
                    local progress = mainParent and mainParent:FindFirstChild("Progress")
                    local progressValue = progress and progress.Value or 0
                    label.Text = string.format("%.1fm\n進度: %.1f%%", distance, progressValue)
                else
                    label.Text = string.format("%.1fm", distance)
                end
            end
        end
    end)
    
    return box, billboard, updateConnection
end

-- 清除指定類型的 ESP
local function clearESP(espType)
    for _, espData in pairs(espObjects[espType]) do
        if espData.box then espData.box:Destroy() end
        if espData.billboard then espData.billboard:Destroy() end
        if espData.connection then espData.connection:Disconnect() end
    end
    espObjects[espType] = {}
end

-- 檢查物品路徑是否包含 itemroot（不區分大小寫）
local function isItemInPath(obj)
    local current = obj
    while current do
        if current.Name:lower() == "itemroot" then
            return true
        end
        current = current.Parent
    end
    return false
end

-- 檢查發電機是否符合條件（路徑包含Main且有Prompt，但排除FakeGenerator）
local function isValidGenerator(obj)
    -- 檢查路徑是否包含 Main
    local hasMain = false
    local mainObject = nil
    local current = obj
    while current do
        if current.Name == "Main" then
            hasMain = true
            mainObject = current
            break
        end
        current = current.Parent
    end
    
    if not hasMain or not mainObject then return false end
    
    -- 檢查 Main 的 Parent 是否為 FakeGenerator（排除假發電機）
    if mainObject.Parent and mainObject.Parent.Name == "FakeGenerator" then
        return false
    end
    
    -- 檢查是否有 Prompt
    local hasPrompt = false
    for _, child in pairs(obj:GetDescendants()) do
        if child:IsA("ProximityPrompt") then
            hasPrompt = true
            break
        end
    end
    
    return hasPrompt
end

-- 發電機 ESP
local function updateGeneratorESP()
    clearESP("generators")
    
    if not toggles.generatorESP then return end
    
    -- 遍歷整個 Workspace，尋找符合條件的發電機
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and isValidGenerator(obj) then
            local box, billboard, connection = createESPBox(obj, Color3.fromRGB(0, 255, 0), "generator")
            table.insert(espObjects.generators, {
                part = obj,
                box = box,
                billboard = billboard,
                connection = connection
            })
        end
    end
end

-- 物品 ESP
local function updateItemESP()
    clearESP("items")
    
    if not toggles.itemESP then return end
    
    -- 遍歷整個 Workspace，尋找路徑包含 itemroot 的物品
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and isItemInPath(obj) then
            local box, billboard, connection = createESPBox(obj, Color3.fromRGB(255, 255, 0), "item")
            table.insert(espObjects.items, {
                part = obj,
                box = box,
                billboard = billboard,
                connection = connection
            })
        end
    end
end

-- 監控新生成的物品和發電機
local function startItemMonitoring()
    if connections.itemESP then connections.itemESP:Disconnect() end
    
    if toggles.itemESP then
        connections.itemESP = Workspace.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("BasePart") and isItemInPath(descendant) then
                task.wait(0.1)
                if toggles.itemESP then
                    local box, billboard, connection = createESPBox(descendant, Color3.fromRGB(255, 255, 0), "item")
                    table.insert(espObjects.items, {
                        part = descendant,
                        box = box,
                        billboard = billboard,
                        connection = connection
                    })
                end
            end
        end)
    end
end

-- 監控新生成的發電機
local function startGeneratorMonitoring()
    if connections.generatorESP then connections.generatorESP:Disconnect() end
    
    if toggles.generatorESP then
        connections.generatorESP = Workspace.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("BasePart") then
                task.wait(0.1)
                if toggles.generatorESP and isValidGenerator(descendant) then
                    local box, billboard, connection = createESPBox(descendant, Color3.fromRGB(0, 255, 0), "generator")
                    table.insert(espObjects.generators, {
                        part = descendant,
                        box = box,
                        billboard = billboard,
                        connection = connection
                    })
                end
            end
        end)
    end
end

-- 重生監聽
player.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    if toggles.speed then applySpeed(newChar) end
    lastCounterEvadeTime = 0
    isCounterEvading = false
end)

-- ====================
-- 自動隱形系統（簡化版 - 只保留一種路徑）
-- ====================

local autoInvisToggles = {
    autoEvade = false
}

local autoInvisValues = {
    evadeRange = 15,
    evadeSpeed = 30
}

local autoInvisConnections = {
    autoEvade = nil
}

local isAutoInvisEvading = false
local lastAutoInvisEvadeTime = 0
local autoInvisEvadeCooldown = 1.5

-- 尋找最近的玩家（包括自己）
local function findNearestPlayerForInvis()
    local char = player.Character
    if not char then return nil, math.huge end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, math.huge end
    
    local nearestPlayer = nil
    local minDistance = math.huge
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer.Character then
            local otherHRP = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherHRP then
                local distance = (hrp.Position - otherHRP.Position).Magnitude
                if distance < minDistance then
                    minDistance = distance
                    nearestPlayer = otherPlayer
                end
            end
        end
    end
    
    return nearestPlayer, minDistance
end

-- 簡化版反繞 - 只使用左後方路徑
local function performSimpleEvade()
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    local targetPlayer, distance = findNearestPlayerForInvis()
    if not targetPlayer then return end
    if distance > autoInvisValues.evadeRange then return end
    
    local targetChar = targetPlayer.Character
    if not targetChar then return end
    
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    -- 檢查是否有障礙物阻擋
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {char, targetChar}
    
    local directionToTarget = targetHRP.Position - hrp.Position
    local rayResult = Workspace:Raycast(hrp.Position, directionToTarget, params)
    
    if rayResult then return end
    
    -- 檢查冷卻時間
    local currentTime = tick()
    if currentTime - lastAutoInvisEvadeTime < autoInvisEvadeCooldown then return end
    
    isAutoInvisEvading = true
    lastAutoInvisEvadeTime = currentTime
    
    local originalAutoRotate = humanoid.AutoRotate
    local evadeRadius = autoInvisValues.evadeRange
    
    task.spawn(function()
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(100000, 0, 100000)
        bodyVelocity.P = 10000
        bodyVelocity.Parent = hrp
        
        humanoid.AutoRotate = false
        
        -- 只使用左後方半圓路徑
        local directionToTarget = (targetHRP.Position - hrp.Position).Unit
        local perpendicular = Vector3.new(-directionToTarget.Z, 0, directionToTarget.X)
        
        local startAngle = math.pi / 2
        local endAngle = math.pi * 1.5
        local centerPos = hrp.Position + perpendicular * evadeRadius
        
        local totalTime = (math.pi * evadeRadius) / autoInvisValues.evadeSpeed
        local steps = math.ceil(totalTime / 0.03)
        local stepAngle = (endAngle - startAngle) / steps
        
        for i = 1, steps do
            if not isAutoInvisEvading or not autoInvisToggles.autoEvade then break end
            
            local angle = startAngle + stepAngle * i
            local nextAngle = startAngle + stepAngle * (i + 1)
            
            local currentOffset = Vector3.new(
                math.cos(angle) * evadeRadius,
                0,
                math.sin(angle) * evadeRadius
            )
            local nextOffset = Vector3.new(
                math.cos(nextAngle) * evadeRadius,
                0,
                math.sin(nextAngle) * evadeRadius
            )
            
            local currentPoint = centerPos + currentOffset
            local nextPoint = centerPos + nextOffset
            
            local moveDirection = (nextPoint - currentPoint).Unit
            bodyVelocity.Velocity = moveDirection * autoInvisValues.evadeSpeed
            
            local lookDirection = moveDirection * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        -- 反繞完成後繼續前進
        local finalDirection = (hrp.Position - targetHRP.Position).Unit
        local forwardDistance = evadeRadius
        local forwardTime = forwardDistance / autoInvisValues.evadeSpeed
        local forwardSteps = math.ceil(forwardTime / 0.03)
        
        for i = 1, forwardSteps do
            if not isAutoInvisEvading or not autoInvisToggles.autoEvade then break end
            
            bodyVelocity.Velocity = finalDirection * autoInvisValues.evadeSpeed
            
            local lookDirection = finalDirection * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        bodyVelocity:Destroy()
        humanoid.AutoRotate = originalAutoRotate
        isAutoInvisEvading = false
    end)
end

-- 自動隱形監控
local function startAutoInvisible()
    if autoInvisConnections.autoEvade then autoInvisConnections.autoEvade:Disconnect() end
    
    if autoInvisToggles.autoEvade then
        autoInvisConnections.autoEvade = RunService.Heartbeat:Connect(function()
            if not isAutoInvisEvading then
                performSimpleEvade()
            end
        end)
    end
end

-- ====================
-- UI 建構
-- ====================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedJumpController"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
screenGui.DisplayOrder = 10001

local function parentUI(g)
    local success = pcall(function()
        if gethui then g.Parent = gethui()
        elseif CoreGui then g.Parent = CoreGui
        else g.Parent = playerGui end
    end)
    if not success then g.Parent = playerGui end
end
parentUI(screenGui)

-- 主視窗
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 262)
mainFrame.Position = UDim2.new(0.5, -130, 0.5, -131)
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 10)

-- 標題欄
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 32)
titleBar.BackgroundColor3 = Color3.fromRGB(102, 126, 234)
titleBar.Parent = mainFrame
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 1, 0)
title.BackgroundTransparency = 1
title.Text = "貓玲的forsaken控制器"
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Parent = titleBar

local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 24, 0, 24)
minimizeButton.Position = UDim2.new(1, -54, 0, 4)
minimizeButton.BackgroundColor3 = Color3.fromRGB(158, 158, 158)
minimizeButton.Text = "─"
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.Parent = titleBar
Instance.new("UICorner", minimizeButton).CornerRadius = UDim.new(0, 5)

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 24, 0, 24)
closeButton.Position = UDim2.new(1, -28, 0, 4)
closeButton.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Parent = titleBar
Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 5)

-- 分頁系統
local tabBar = Instance.new("Frame")
tabBar.Size = UDim2.new(0.9, 0, 0, 28)
tabBar.Position = UDim2.new(0.05, 0, 0, 38)
tabBar.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
tabBar.Parent = mainFrame
Instance.new("UICorner", tabBar).CornerRadius = UDim.new(0, 6)

local function createTab(text, index)
    local tab = Instance.new("TextButton")
    tab.Size = UDim2.new(0.33, -4, 1, -4)
    tab.Position = UDim2.new((index-1) * 0.33, 2, 0, 2)
    tab.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    tab.Text = text
    tab.TextSize = 12
    tab.Font = Enum.Font.GothamBold
    tab.TextColor3 = Color3.fromRGB(100, 100, 100)
    tab.Parent = tabBar
    Instance.new("UICorner", tab).CornerRadius = UDim.new(0, 4)
    return tab
end

local tab1 = createTab("基本設置", 1)
local tab2 = createTab("防反繞", 2)
local tab3 = createTab("其他", 3)

local contentContainer = Instance.new("Frame")
contentContainer.Size = UDim2.new(0.9, 0, 0, 150) 
contentContainer.Position = UDim2.new(0.05, 0, 0, 72)
contentContainer.BackgroundTransparency = 1
contentContainer.Parent = mainFrame
contentContainer.ClipsDescendants = true 

local function createScrollingPage(parent)
    local page = Instance.new("ScrollingFrame")
    page.Size = UDim2.new(1, 0, 1, 0)
    page.BackgroundTransparency = 1
    page.BorderSizePixel = 0
    page.ScrollBarThickness = 4
    page.AutomaticCanvasSize = Enum.AutomaticSize.Y
    page.Visible = false
    page.Parent = parent
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 6)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Parent = page
    local padding = Instance.new("UIPadding")
    padding.PaddingRight = UDim.new(0, 6)
    padding.Parent = page
    return page
end

local page1 = createScrollingPage(contentContainer)
local page2 = createScrollingPage(contentContainer)
local page3 = createScrollingPage(contentContainer)
page1.Visible = true

local function switchTab(pageNum)
    page1.Visible = (pageNum == 1)
    page2.Visible = (pageNum == 2)
    page3.Visible = (pageNum == 3)
    tab1.BackgroundColor3 = (pageNum == 1) and Color3.fromRGB(102, 126, 234) or Color3.fromRGB(200, 200, 200)
    tab1.TextColor3 = (pageNum == 1) and Color3.new(1,1,1) or Color3.fromRGB(100,100,100)
    tab2.BackgroundColor3 = (pageNum == 2) and Color3.fromRGB(102, 126, 234) or Color3.fromRGB(200, 200, 200)
    tab2.TextColor3 = (pageNum == 2) and Color3.new(1,1,1) or Color3.fromRGB(100,100,100)
    tab3.BackgroundColor3 = (pageNum == 3) and Color3.fromRGB(102, 126, 234) or Color3.fromRGB(200, 200, 200)
    tab3.TextColor3 = (pageNum == 3) and Color3.new(1,1,1) or Color3.fromRGB(100,100,100)
end
tab1.MouseButton1Click:Connect(function() switchTab(1) end)
tab2.MouseButton1Click:Connect(function() switchTab(2) end)
tab3.MouseButton1Click:Connect(function() switchTab(3) end)

-- 通用UI創建函數
local function createControlRow(parent, labelText, placeholder, defaultVal, isInput, order)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 32)
    frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
    frame.LayoutOrder = order or 0
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 75, 1, 0)
    label.Position = UDim2.new(0, 6, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(85, 85, 85)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local input
    if isInput then
        input = Instance.new("TextBox")
        input.Size = UDim2.new(0, 65, 0, 22)
        input.Position = UDim2.new(0, 80, 0, 5)
        input.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        input.BorderSizePixel = 1; input.BorderColor3 = Color3.fromRGB(221,221,221)
        input.Text = defaultVal
        input.PlaceholderText = placeholder
        input.TextSize = 13
        input.Font = Enum.Font.Gotham
        input.TextColor3 = Color3.fromRGB(50, 50, 50)
        input.Parent = frame
        Instance.new("UICorner", input).CornerRadius = UDim.new(0, 5)
    else
        input = Instance.new("TextLabel")
        input.Size = UDim2.new(0, 65, 0, 22)
        input.Position = UDim2.new(0, 80, 0, 5)
        input.BackgroundTransparency = 1
        input.Text = "關閉"
        input.TextSize = 13
        input.Font = Enum.Font.Gotham
        input.TextColor3 = Color3.fromRGB(150, 150, 150)
        input.Parent = frame
    end

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 50, 0, 22)
    btn.Position = UDim2.new(1, -55, 0, 5)
    btn.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
    btn.Text = "啟動"
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Parent = frame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)

    return frame, input, btn
end

-- 創建無按鈕的輸入行
local function createInputOnlyRow(parent, labelText, defaultVal, order)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 32)
    frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
    frame.LayoutOrder = order or 0
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 120, 1, 0)
    label.Position = UDim2.new(0, 6, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(85, 85, 85)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local input = Instance.new("TextBox")
    input.Size = UDim2.new(0, 100, 0, 22)
    input.Position = UDim2.new(1, -105, 0, 5)
    input.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    input.BorderSizePixel = 1
    input.BorderColor3 = Color3.fromRGB(221, 221, 221)
    input.Text = defaultVal
    input.TextSize = 13
    input.Font = Enum.Font.Gotham
    input.TextColor3 = Color3.fromRGB(50, 50, 50)
    input.Parent = frame
    Instance.new("UICorner", input).CornerRadius = UDim.new(0, 5)

    return frame, input
end

-- 頁面 1 - 基本設置
local speedFrame, speedInput, speedButton = createControlRow(page1, "速度:", "34", "34", true, 1)
local fullbrightFrame, fullbrightInput, fullbrightButton = createControlRow(page1, "全亮:", "1", "1", true, 2)
local cameraDistFrame, cameraDistInput, cameraDistButton = createControlRow(page1, "鏡頭距離:", "80", "80", true, 3)
local nofogFrame, nofogStatus, nofogButton = createControlRow(page1, "除霧:", "", "", false, 4)
local noFilterFrame, noFilterStatus, noFilterButton = createControlRow(page1, "無濾鏡:", "", "", false, 5)

-- 頁面 2 - 防反繞
local evadeFrame, evadeStatus, evadeButton = createControlRow(page2, "防反繞:", "", "", false, 1)
local evadeRangeFrame, evadeRangeInput = createInputOnlyRow(page2, "追擊範圍:", "15", 2)
local evadeSpeedFrame, evadeSpeedInput = createInputOnlyRow(page2, "追擊速度:", "30", 3)

-- 添加防反繞模式選擇
local counterModeFrame = Instance.new("Frame")
counterModeFrame.Size = UDim2.new(1, 0, 0, 35)
counterModeFrame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
counterModeFrame.BorderSizePixel = 0
counterModeFrame.LayoutOrder = 4
counterModeFrame.Parent = page2
Instance.new("UICorner", counterModeFrame).CornerRadius = UDim.new(0, 6)

local counterModeLabel = Instance.new("TextLabel")
counterModeLabel.Size = UDim2.new(0.35, 0, 1, 0)
counterModeLabel.Position = UDim2.new(0, 8, 0, 0)
counterModeLabel.BackgroundTransparency = 1
counterModeLabel.Text = "防反繞模式:"
counterModeLabel.TextSize = 12
counterModeLabel.Font = Enum.Font.GothamMedium
counterModeLabel.TextColor3 = Color3.fromRGB(33, 33, 33)
counterModeLabel.TextXAlignment = Enum.TextXAlignment.Left
counterModeLabel.Parent = counterModeFrame

local counterModeButton = Instance.new("TextButton")
counterModeButton.Size = UDim2.new(0.3, 0, 0, 26)
counterModeButton.Position = UDim2.new(0.68, 0, 0.5, -13)
counterModeButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
counterModeButton.Text = "偽裝"
counterModeButton.TextSize = 11
counterModeButton.Font = Enum.Font.GothamBold
counterModeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
counterModeButton.Parent = counterModeFrame
Instance.new("UICorner", counterModeButton).CornerRadius = UDim.new(0, 5)

local counterModeStatus = Instance.new("TextLabel")
counterModeStatus.Size = UDim2.new(0.25, 0, 1, 0)
counterModeStatus.Position = UDim2.new(0.38, 0, 0, 0)
counterModeStatus.BackgroundTransparency = 1
counterModeStatus.Text = "偽裝"
counterModeStatus.TextSize = 11
counterModeStatus.Font = Enum.Font.GothamBold
counterModeStatus.TextColor3 = Color3.fromRGB(76, 175, 80)
counterModeStatus.Parent = counterModeFrame

-- 頁面 3 - 其他
local generatorESPFrame, generatorESPStatus, generatorESPButton = createControlRow(page3, "發電機顯示:", "", "", false, 1)
local itemESPFrame, itemESPStatus, itemESPButton = createControlRow(page3, "物品顯示:", "", "", false, 2)
local autoInvisFrame, autoInvisStatus, autoInvisButton = createControlRow(page3, "隱形(可能掉虛空):", "", "", false, 3)

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(0.9, 0, 0, 26)
statusLabel.Position = UDim2.new(0.05, 0, 1, -32)
statusLabel.BackgroundColor3 = Color3.fromRGB(255, 235, 238)
statusLabel.Text = "系統就緒"
statusLabel.TextSize = 11
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextColor3 = Color3.fromRGB(198, 40, 40)
statusLabel.Parent = mainFrame
Instance.new("UICorner", statusLabel).CornerRadius = UDim.new(0, 5)

-- ====================
-- 功能實作
-- ====================

local function updateStatus()
    local active = {}
    if toggles.speed then table.insert(active, "速度") end
    if toggles.fullbright then table.insert(active, "全亮") end
    if toggles.counterEvade then table.insert(active, "防反繞") end
    
    if #active > 0 then
        statusLabel.Text = "✅ " .. table.concat(active, " | ")
        statusLabel.BackgroundColor3 = Color3.fromRGB(232, 245, 233)
        statusLabel.TextColor3 = Color3.fromRGB(46, 125, 50)
    else
        statusLabel.Text = "系統就緒"
        statusLabel.BackgroundColor3 = Color3.fromRGB(255, 235, 238)
        statusLabel.TextColor3 = Color3.fromRGB(198, 40, 40)
    end
end

local function toggleUIState(btn, frame, input, isActive)
    if isActive then
        btn.Text = "解除"; btn.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
        frame.BackgroundColor3 = Color3.fromRGB(227, 242, 253)
        if input and input:IsA("TextBox") then input.TextEditable = false end
    else
        btn.Text = "啟動"; btn.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
        frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
        if input and input:IsA("TextBox") then input.TextEditable = true end
    end
    updateStatus()
end

-- 速度
speedButton.MouseButton1Click:Connect(function()
    toggles.speed = not toggles.speed
    if toggles.speed then
        if not hasOriginalValues then getOriginalValues() end
        values.speed = tonumber(speedInput.Text) or 34
        applySpeed()
    else
        applySpeed()
    end
    toggleUIState(speedButton, speedFrame, speedInput, toggles.speed)
end)

-- 全亮
fullbrightButton.MouseButton1Click:Connect(function()
    toggles.fullbright = not toggles.fullbright
    if toggles.fullbright then
        local val = tonumber(fullbrightInput.Text) or 1
        values.fullbright = math.clamp(val, 0, 99)
        if val ~= values.fullbright then fullbrightInput.Text = tostring(values.fullbright) end
    end
    updateLighting()
    toggleUIState(fullbrightButton, fullbrightFrame, fullbrightInput, toggles.fullbright)
end)

-- 無濾鏡
noFilterButton.MouseButton1Click:Connect(function()
    toggles.noFilter = not toggles.noFilter
    if toggles.noFilter then
        noFilterStatus.Text = "開啟"
        noFilterStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        if connections.noFilter then connections.noFilter:Disconnect() end
        connections.noFilter = RunService.RenderStepped:Connect(function()
            for _, v in pairs(Lighting:GetChildren()) do
                if v:IsA("PostEffect") then v:Destroy() end
            end
            if Workspace.CurrentCamera then
                 for _, v in pairs(Workspace.CurrentCamera:GetChildren()) do
                    if v:IsA("PostEffect") then v:Destroy() end
                end
            end
        end)
    else
        noFilterStatus.Text = "關閉"
        noFilterStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        if connections.noFilter then connections.noFilter:Disconnect() end
    end
    toggleUIState(noFilterButton, noFilterFrame, noFilterStatus, toggles.noFilter)
end)

-- 除霧
nofogButton.MouseButton1Click:Connect(function()
    toggles.nofog = not toggles.nofog
    if toggles.nofog then
        nofogStatus.Text = "開啟"; nofogStatus.TextColor3 = Color3.fromRGB(46,125,50)
        if connections.nofog then connections.nofog:Disconnect() end
        connections.nofog = RunService.RenderStepped:Connect(function()
            Lighting.FogEnd = 100000
            for _, v in pairs(Lighting:GetDescendants()) do
                if v:IsA("Atmosphere") then v.Density = 0; v.Offset = 0 end
            end
        end)
    else
        nofogStatus.Text = "關閉"; nofogStatus.TextColor3 = Color3.fromRGB(150,150,150)
        if connections.nofog then connections.nofog:Disconnect() end
        Lighting.FogEnd = trueLightingBackup.FogEnd or 1000
    end
    toggleUIState(nofogButton, nofogFrame, nofogStatus, toggles.nofog)
end)

-- 鏡頭距離
cameraDistButton.MouseButton1Click:Connect(function()
    toggles.cameraDist = not toggles.cameraDist
    if toggles.cameraDist then
        values.cameraDist = tonumber(cameraDistInput.Text) or 80
        player.CameraMaxZoomDistance = values.cameraDist
        player.CameraMinZoomDistance = values.cameraDist
        if player.Character then
            local hum = player.Character:FindFirstChildOfClass("Humanoid")
            if hum then hum.CameraOffset = Vector3.new(0,0,0) end
        end
        task.delay(0.1, function()
            if toggles.cameraDist then player.CameraMinZoomDistance = 0.5 end
        end)
    else
        player.CameraMaxZoomDistance = 128
        player.CameraMinZoomDistance = 0.5
    end
    toggleUIState(cameraDistButton, cameraDistFrame, cameraDistInput, toggles.cameraDist)
end)

-- 防反繞
evadeButton.MouseButton1Click:Connect(function()
    toggles.counterEvade = not toggles.counterEvade
    if toggles.counterEvade then
        values.evadeRange = tonumber(evadeRangeInput.Text) or 15
        values.evadeSpeed = tonumber(evadeSpeedInput.Text) or 30
        
        startCounterEvade()
        evadeStatus.Text = "開啟"
        evadeStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    else
        if connections.counterEvade then connections.counterEvade:Disconnect() end
        evadeStatus.Text = "關閉"
        evadeStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
    end
    toggleUIState(evadeButton, evadeFrame, evadeStatus, toggles.counterEvade)
end)

-- 防反繞模式切換按鈕
counterModeButton.MouseButton1Click:Connect(function()
    if toggles.counterEvadeMode == "disguise" then
        toggles.counterEvadeMode = "fullpower"
        counterModeButton.Text = "全開"
        counterModeButton.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
        counterModeStatus.Text = "全開"
        counterModeStatus.TextColor3 = Color3.fromRGB(244, 67, 54)
    else
        toggles.counterEvadeMode = "disguise"
        counterModeButton.Text = "偽裝"
        counterModeButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
        counterModeStatus.Text = "偽裝"
        counterModeStatus.TextColor3 = Color3.fromRGB(76, 175, 80)
    end
end)

-- 更新防反繞參數
evadeRangeInput.FocusLost:Connect(function()
    values.evadeRange = tonumber(evadeRangeInput.Text) or 15
    evadeRangeInput.Text = tostring(values.evadeRange)
end)

evadeSpeedInput.FocusLost:Connect(function()
    values.evadeSpeed = tonumber(evadeSpeedInput.Text) or 30
    evadeSpeedInput.Text = tostring(values.evadeSpeed)
end)

-- 發電機顯示
generatorESPButton.MouseButton1Click:Connect(function()
    toggles.generatorESP = not toggles.generatorESP
    if toggles.generatorESP then
        generatorESPStatus.Text = "開啟"
        generatorESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        updateGeneratorESP()
        startGeneratorMonitoring()
    else
        generatorESPStatus.Text = "關閉"
        generatorESPStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        clearESP("generators")
        if connections.generatorESP then connections.generatorESP:Disconnect() end
    end
    toggleUIState(generatorESPButton, generatorESPFrame, generatorESPStatus, toggles.generatorESP)
end)

-- 物品顯示
itemESPButton.MouseButton1Click:Connect(function()
    toggles.itemESP = not toggles.itemESP
    if toggles.itemESP then
        itemESPStatus.Text = "開啟"
        itemESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        updateItemESP()
        startItemMonitoring()
    else
        itemESPStatus.Text = "關閉"
        itemESPStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        clearESP("items")
        if connections.itemESP then connections.itemESP:Disconnect() end
    end
    toggleUIState(itemESPButton, itemESPFrame, itemESPStatus, toggles.itemESP)
end)

-- 隱形按鈕
autoInvisButton.MouseButton1Click:Connect(function()
    toggles.autoInvisible = not toggles.autoInvisible
    autoInvisToggles.autoEvade = toggles.autoInvisible
    
    if toggles.autoInvisible then
        startAutoInvisible()
        autoInvisStatus.Text = "開啟"
        autoInvisStatus.TextColor3 = Color3.fromRGB(138, 43, 226)
    else
        if autoInvisConnections.autoEvade then autoInvisConnections.autoEvade:Disconnect() end
        autoInvisStatus.Text = "關閉"
        autoInvisStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
    end
    toggleUIState(autoInvisButton, autoInvisFrame, autoInvisStatus, toggles.autoInvisible)
end)

-- 自動啟用功能
task.spawn(function()
    task.wait(1)
    
    -- 自動啟用全亮
    toggles.fullbright = true
    updateLighting()
    toggleUIState(fullbrightButton, fullbrightFrame, fullbrightInput, true)
    
    -- 自動啟用鏡頭距離
    toggles.cameraDist = true
    player.CameraMaxZoomDistance = values.cameraDist
    player.CameraMinZoomDistance = values.cameraDist
    task.delay(0.1, function()
        if toggles.cameraDist then player.CameraMinZoomDistance = 0.5 end
    end)
    toggleUIState(cameraDistButton, cameraDistFrame, cameraDistInput, true)
    
    -- 自動啟用除霧
    toggles.nofog = true
    if connections.nofog then connections.nofog:Disconnect() end
    connections.nofog = RunService.RenderStepped:Connect(function()
        Lighting.FogEnd = 100000
        for _, v in pairs(Lighting:GetDescendants()) do
            if v:IsA("Atmosphere") then v.Density = 0; v.Offset = 0 end
        end
    end)
    nofogStatus.Text = "開啟"
    nofogStatus.TextColor3 = Color3.fromRGB(46,125,50)
    toggleUIState(nofogButton, nofogFrame, nofogStatus, true)
    
    -- 自動啟用無濾鏡
    toggles.noFilter = true
    if connections.noFilter then connections.noFilter:Disconnect() end
    connections.noFilter = RunService.RenderStepped:Connect(function()
        for _, v in pairs(Lighting:GetChildren()) do
            if v:IsA("PostEffect") then v:Destroy() end
        end
        if Workspace.CurrentCamera then
             for _, v in pairs(Workspace.CurrentCamera:GetChildren()) do
                if v:IsA("PostEffect") then v:Destroy() end
            end
        end
    end)
    noFilterStatus.Text = "開啟"
    noFilterStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    toggleUIState(noFilterButton, noFilterFrame, noFilterStatus, true)

    -- 自動啟用發電機顯示
    toggles.generatorESP = true
    generatorESPStatus.Text = "開啟"
    generatorESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    updateGeneratorESP()
    startGeneratorMonitoring()
    toggleUIState(generatorESPButton, generatorESPFrame, generatorESPStatus, true)
    
    -- 自動啟用物品顯示
    toggles.itemESP = true
    itemESPStatus.Text = "開啟"
    itemESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    updateItemESP()
    startItemMonitoring()
    toggleUIState(itemESPButton, itemESPFrame, itemESPStatus, true)
end)

-- 拖曳功能
local function enableDrag(frame, dragHandle)
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

enableDrag(mainFrame, titleBar)

-- 最小化UI
local miniFrame = Instance.new("Frame"); miniFrame.Size=UDim2.new(0,130,0,32); miniFrame.Position=UDim2.new(0.5,-65,0,30); miniFrame.BackgroundColor3=Color3.fromRGB(102,126,234); miniFrame.Visible=false; miniFrame.Parent=screenGui; Instance.new("UICorner", miniFrame).CornerRadius=UDim.new(0,6)
local miniTitle = Instance.new("TextLabel"); miniTitle.Text="🎮 控制器"; miniTitle.Size=UDim2.new(1,-36,1,0); miniTitle.BackgroundTransparency=1; miniTitle.Font=Enum.Font.GothamBold; miniTitle.TextSize=16; miniTitle.TextColor3=Color3.fromRGB(255,255,255); miniTitle.Parent=miniFrame
local expandButton = Instance.new("TextButton"); expandButton.Text="+"; expandButton.Size=UDim2.new(0,24,0,24); expandButton.Position=UDim2.new(1,-28,0,4); expandButton.BackgroundColor3=Color3.fromRGB(76,175,80); expandButton.TextColor3=Color3.fromRGB(255,255,255); expandButton.Parent=miniFrame; Instance.new("UICorner", expandButton).CornerRadius=UDim.new(0,5)
enableDrag(miniFrame, miniFrame)

minimizeButton.MouseButton1Click:Connect(function() mainFrame.Visible=false; miniFrame.Visible=true end)
expandButton.MouseButton1Click:Connect(function() miniFrame.Visible=false; mainFrame.Visible=true end)

-- 關閉按鈕
closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
    for _, v in pairs(connections) do if v then v:Disconnect() end end
    
    clearESP("generators")
    clearESP("items")
    
    Lighting.Ambient = trueLightingBackup.Ambient
    Lighting.Brightness = trueLightingBackup.Brightness
    Lighting.OutdoorAmbient = trueLightingBackup.OutdoorAmbient
    Lighting.ColorShift_Top = trueLightingBackup.ColorShift_Top
    Lighting.ColorShift_Bottom = trueLightingBackup.ColorShift_Bottom
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.WalkSpeed = originalSpeed
        end
    end
end)

-- 初始化
task.spawn(function()
    if player.Character then task.wait(0.1); getOriginalValues() end
end)

print(update)
print(update2)

-- ====================
-- ShiftLock + ESP UI 整合（新版）
-- ====================
task.spawn(function()
    pcall(function()
        local ref = cloneref or function(x) return x end
        local S = function(n) return ref(game:GetService(n)) end

        local Plrs, Tw, UIS, RS, Wk, CG =
            S("Players"), S("TweenService"), S("UserInputService"), S("RunService"), S("Workspace"), S("CoreGui")

        local plr = Plrs.LocalPlayer

        local function parentShiftUI(g)
            if gethui then
                g.Name = "\0" .. g.Name
                g.Parent = gethui()
                return g
            elseif CG then
                g.Parent = CG
                return g
            else
                g.Parent = plr:WaitForChild("PlayerGui")
                return g
            end
        end

        shiftLockUI = Instance.new("ScreenGui")
        shiftLockUI.Name = "ShiftLockUI"
        shiftLockUI.ResetOnSpawn = false
        shiftLockUI.IgnoreGuiInset = true
        parentShiftUI(shiftLockUI)

        -- 按鈕變數
        local btn, nearBtn, clickBtn, espBtn, strk, icn

        local function updateButtonState(button, active)
            local activeColor = Color3.fromRGB(50, 100, 150)
            local inactiveColor = Color3.fromRGB(40, 40, 45)
            
            Tw:Create(button, TweenInfo.new(0.2), {
                BackgroundColor3 = active and activeColor or inactiveColor
            }):Play()
            
            local stroke = button:FindFirstChild("BtnStroke")
            if stroke then
                Tw:Create(stroke, TweenInfo.new(0.2), {
                    Color = active and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(80, 80, 90),
                    Thickness = active and 2 or 1
                }):Play()
            end
        end

        local function clearAllModesUI()
            if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
            if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
            
            if UIS.MouseEnabled then
                UIS.MouseBehavior = Enum.MouseBehavior.Default
            end
            
            local char = plr.Character
            if char then
                local h = char:FindFirstChildOfClass("Humanoid")
                if h then h.AutoRotate = true end
            end
            
            icn.Image = "rbxasset://textures/ui/mouseLock_off.png"
            Tw:Create(strk, TweenInfo.new(0.2), {Color = Color3.fromRGB(0, 140, 255), Thickness = 2}):Play()
            Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(34, 34, 38)}):Play()
            updateButtonState(nearBtn, false)
            updateButtonState(clickBtn, false)
            lockMode = "none"
            shiftLockEnabled = false
            lockTargetPlayer = nil
            lastClickedPlayer = nil
        end

        -- UI 創建
        btn = Instance.new("ImageButton")
        btn.Name = "LockBtn"; btn.AnchorPoint = Vector2.new(0.5, 0.5); btn.Size = UDim2.fromOffset(64, 64)
        btn.Position = UDim2.new(1, -30, 1, -30); btn.BackgroundColor3 = Color3.fromRGB(34, 34, 38)
        btn.AutoButtonColor = false; btn.Parent = shiftLockUI
        local cr = Instance.new("UICorner"); cr.CornerRadius = UDim.new(1, 0); cr.Parent = btn
        strk = Instance.new("UIStroke"); strk.Thickness = 2; strk.Color = Color3.fromRGB(0, 140, 255); strk.Parent = btn
        icn = Instance.new("ImageLabel")
        icn.Name = "Icn"; icn.BackgroundTransparency = 1; icn.AnchorPoint = Vector2.new(0.5, 0.5)
        icn.Position = UDim2.fromScale(0.5, 0.5); icn.Size = UDim2.fromScale(0.62, 0.62)
        icn.Image = "rbxasset://textures/ui/mouseLock_off.png"; icn.Parent = btn

        -- 專用拖曳把手
        local dragHandle = Instance.new("Frame")
        dragHandle.Name = "DragHandle"
        dragHandle.AnchorPoint = Vector2.new(0.5, 1)
        dragHandle.Position = UDim2.new(0.5, 0, 0, -2)
        dragHandle.Size = UDim2.fromOffset(40, 6)
        dragHandle.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
        dragHandle.BorderSizePixel = 0
        dragHandle.Parent = btn
        
        local handleCorner = Instance.new("UICorner")
        handleCorner.CornerRadius = UDim.new(1, 0)
        handleCorner.Parent = dragHandle
        
        -- 拖曳把手的視覺提示（3個小點）
        local dot1 = Instance.new("Frame")
        dot1.Size = UDim2.fromOffset(2, 2)
        dot1.Position = UDim2.new(0.3, 0, 0.5, -1)
        dot1.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        dot1.BorderSizePixel = 0
        dot1.Parent = dragHandle
        Instance.new("UICorner", dot1).CornerRadius = UDim.new(1, 0)
        
        local dot2 = dot1:Clone()
        dot2.Position = UDim2.new(0.5, 0, 0.5, -1)
        dot2.Parent = dragHandle
        
        local dot3 = dot1:Clone()
        dot3.Position = UDim2.new(0.7, 0, 0.5, -1)
        dot3.Parent = dragHandle

        local xBtn = Instance.new("TextButton")
        xBtn.Name = "Close"; xBtn.AnchorPoint = Vector2.new(1, 0); xBtn.Position = UDim2.new(1, 5, 0, -5)
        xBtn.Size = UDim2.fromOffset(18, 18); xBtn.BackgroundColor3 = Color3.fromRGB(230, 60, 60); xBtn.Text = "×"
        xBtn.TextSize = 14; xBtn.TextColor3 = Color3.new(1, 1, 1); xBtn.Parent = btn
        Instance.new("UICorner").Parent = xBtn

        local extBtn = Instance.new("TextButton")
        extBtn.Name = "ExtendBtn"; extBtn.AnchorPoint = Vector2.new(0.5, 1); extBtn.Position = UDim2.new(0.5, 0, 0, -15)
        extBtn.Size = UDim2.fromOffset(56, 22); extBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
        extBtn.Text = "延伸"; extBtn.TextSize = 12
        extBtn.TextColor3 = Color3.new(1, 1, 1)
        extBtn.Parent = btn
        Instance.new("UICorner").Parent = extBtn

        local extFrame = Instance.new("Frame")
        extFrame.Name = "ExtFrame"; extFrame.AnchorPoint = Vector2.new(0.5, 1); extFrame.Position = UDim2.new(0.5, 0, 0, -42)
        extFrame.Size = UDim2.fromOffset(64, 0); extFrame.BackgroundTransparency = 1; extFrame.ClipsDescendants = true; extFrame.Parent = btn

        local function createExtraBtn(name, yPos)
            local b = Instance.new("TextButton")
            b.Name = name; b.Size = UDim2.fromOffset(60, 26); b.Position = UDim2.fromOffset(2, yPos)
            b.BackgroundColor3 = Color3.fromRGB(40, 40, 45); b.Text = name; b.TextSize = 11; b.TextColor3 = Color3.new(1,1,1); b.Parent = extFrame
            local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0.2,0); c.Parent = b
            local s = Instance.new("UIStroke"); s.Thickness = 1; s.Color = Color3.fromRGB(80, 80, 90); s.Name = "BtnStroke"; s.Parent = b
            return b
        end

        espBtn = createExtraBtn("ESP", 0)
        nearBtn = createExtraBtn("面向最近玩家", 30)
        clickBtn = createExtraBtn("面向雙擊玩家", 60)

        -- 延伸按鈕邏輯
        local extended = false
        extBtn.Activated:Connect(function()
            extended = not extended
            extBtn.Text = extended and "收回" or "延伸"
            extBtn.TextColor3 = Color3.new(1, 1, 1)
            Tw:Create(extFrame, TweenInfo.new(0.3), {Size = UDim2.fromOffset(64, extended and 90 or 0)}):Play()
        end)

        -- 主 ShiftLock 按鈕
        btn.Activated:Connect(function()
            if lockMode == "shiftlock" then 
                clearAllModesUI() 
            else 
                clearAllModesUI()
                lockMode = "shiftlock"
                shiftLockEnabled = true
                if UIS.MouseEnabled then
                    UIS.MouseBehavior = Enum.MouseBehavior.LockCenter
                end
                setFaceRotation("shiftlock")
                icn.Image = "rbxasset://textures/ui/mouseLock_on.png"
                Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(38, 48, 60)}):Play()
            end
        end)

        -- 面向最近玩家
        nearBtn.Activated:Connect(function()
            if lockMode == "nearest" then 
                clearAllModesUI() 
            else 
                clearAllModesUI()
                lockMode = "nearest"
                updateButtonState(nearBtn, true)
                setFaceRotation("nearest")
            end
        end)

        -- 面向雙擊玩家
        clickBtn.Activated:Connect(function()
            if lockMode == "click" then 
                clearAllModesUI()
            else
                clearAllModesUI()
                lockMode = "click"
                updateButtonState(clickBtn, true)
                
                lockMouseClickConn = plr:GetMouse().Button1Down:Connect(function()
                    local mouse = plr:GetMouse()
                    local cam = Wk.CurrentCamera
                    local ray = cam:ScreenPointToRay(mouse.X, mouse.Y)
                    local foundPlayer = nil
                    local minDistance = math.huge
                    
                    for _, p in ipairs(Plrs:GetPlayers()) do
                        if p ~= plr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local hrp = p.Character.HumanoidRootPart
                            local rayToPlayer = hrp.Position - ray.Origin
                            local projection = rayToPlayer:Dot(ray.Direction.Unit)
                            if projection > 0 then
                                local closestPoint = ray.Origin + ray.Direction.Unit * projection
                                local distance = (hrp.Position - closestPoint).Magnitude
                                if distance < 8 and projection < minDistance then 
                                    minDistance = projection
                                    foundPlayer = p 
                                end
                            end
                        end
                    end
                    
                    if foundPlayer and foundPlayer ~= plr then
                        local now = tick()
                        if lastClickedPlayer == foundPlayer and (now - lastClickTime) < 0.5 then 
                            lockTargetPlayer = foundPlayer
                            setFaceRotation("click", foundPlayer)
                        end
                        lastClickedPlayer = foundPlayer
                        lastClickTime = now
                    end
                end)
            end
        end)

        -- ESP 功能
        local espEnabled = false
        local espLabels = {}
        local espBoxes = {}
        local espConn = nil

        local function cleanupESP(p)
            if espLabels[p] then
                if espLabels[p].billboard then espLabels[p].billboard:Destroy() end
                espLabels[p] = nil
            end
            if espBoxes[p] then
                espBoxes[p]:Destroy()
                espBoxes[p] = nil
            end
        end

        local function createESPBox(character)
            local box = Instance.new("BoxHandleAdornment")
            box.Name = "ESPBox"; box.AlwaysOnTop = true; box.ZIndex = 1
            box.Transparency = 0.7; box.Color3 = Color3.new(1, 1, 1); box.Parent = shiftLockUI
            return box
        end

        espBtn.Activated:Connect(function()
            espEnabled = not espEnabled
            updateButtonState(espBtn, espEnabled)
            
            if not espEnabled then
                if espConn then espConn:Disconnect(); espConn = nil end
                for p, _ in pairs(espLabels) do cleanupESP(p) end
                for p, _ in pairs(espBoxes) do cleanupESP(p) end
            else
                espConn = RS.RenderStepped:Connect(function()
                    local myChar = plr.Character
                    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
                    
                    for _, p in ipairs(Plrs:GetPlayers()) do
                        if p ~= plr then
                            local char = p.Character
                            local hrp = char and char:FindFirstChild("HumanoidRootPart")
                            local hum = char and char:FindFirstChildOfClass("Humanoid")
                            if char and hrp and hum and hum.Health > 0 then
                                if not espLabels[p] then
                                    local bg = Instance.new("BillboardGui")
                                    bg.Size = UDim2.fromOffset(200, 50); bg.AlwaysOnTop = true
                                    bg.StudsOffset = Vector3.new(0, 3, 0); bg.Parent = shiftLockUI
                                    local tl = Instance.new("TextLabel")
                                    tl.Size = UDim2.fromScale(1, 1); tl.BackgroundTransparency = 1
                                    tl.TextColor3 = Color3.new(1, 1, 1); tl.TextStrokeTransparency = 0.5
                                    tl.TextSize = 14; tl.Font = Enum.Font.SourceSansBold; tl.Parent = bg
                                    espLabels[p] = {billboard = bg, label = tl}
                                end
                                if not espBoxes[p] then espBoxes[p] = createESPBox(char) end
                                local dist = myHRP and (myHRP.Position - hrp.Position).Magnitude or 0
                                local lab = espLabels[p]
                                lab.billboard.Adornee = hrp
                                lab.label.Text = string.format("名: %s\n血量: %.0f\n距離: %.1f", p.Name, hum.Health, dist)
                                local box = espBoxes[p]; box.Adornee = char; box.Size = char:GetExtentsSize()
                            else cleanupESP(p) end
                        end
                    end
                    for p, _ in pairs(espLabels) do if not Plrs:FindFirstChild(p.Name) then cleanupESP(p) end end
                end)
            end
        end)

        -- 拖曳功能
        local dragging, dragInput, dragStart, startPos
        
        dragHandle.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = btn.Position
                
                Tw:Create(dragHandle, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(150, 150, 160)}):Play()
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                        Tw:Create(dragHandle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(100, 100, 110)}):Play()
                    end
                end)
            end
        end)
        
        UIS.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - dragStart
                btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)

        -- 關閉按鈕
        xBtn.Activated:Connect(function() 
            clearAllModesUI()
            if espConn then espConn:Disconnect() end
            for p, _ in pairs(espLabels) do cleanupESP(p) end
            for p, _ in pairs(espBoxes) do cleanupESP(p) end
            shiftLockUI:Destroy()
        end)
        
        plr.CharacterAdded:Connect(function()
            task.wait(0.5)
            if lockMode ~= "none" then setFaceRotation(lockMode, lockTargetPlayer) end
        end)

        -- 初始化：自動啟動 ShiftLock
        task.wait(0.1)
        lockMode = "shiftlock"
        shiftLockEnabled = true
        if UIS.MouseEnabled then
            UIS.MouseBehavior = Enum.MouseBehavior.LockCenter
        end
        setFaceRotation("shiftlock")
        icn.Image = "rbxasset://textures/ui/mouseLock_on.png"
        Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(38, 48, 60)}):Play()

        print("✅ ShiftLock + ESP 系統已整合（預設啟動 ShiftLock）")
    end)
end)
