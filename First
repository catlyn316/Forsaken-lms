local update = "Roblox å…¨èƒ½æ§åˆ¶å™¨(ä¿®æ”¹ç‰ˆ v2.1 - é¬¼æŠ“äººéŠæˆ²é€šç”¨)å·²è¼‰å…¥"
local update2 = "æ›´æ–°ï¼šdie of deathåˆ†é åŠ å…¥å®Œæ•´11å€‹èƒ½åŠ›èˆ‡å†·å»å€’æ•¸é¡¯ç¤º"

local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")
local Workspace = game:GetService("Workspace")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")
local PathfindingService = game:GetService("PathfindingService")
local TweenService = game:GetService("TweenService")

-- é˜²æ­¢é‡è¤‡åŸ·è¡Œ
if CoreGui:FindFirstChild("SpeedJumpController") then CoreGui.SpeedJumpController:Destroy() end
if playerGui:FindFirstChild("SpeedJumpController") then playerGui.SpeedJumpController:Destroy() end
if CoreGui:FindFirstChild("ShiftLockUI") then CoreGui.ShiftLockUI:Destroy() end
if playerGui:FindFirstChild("ShiftLockUI") then playerGui.ShiftLockUI:Destroy() end

-- ShiftLock ç³»çµ±è®Šæ•¸ï¼ˆæ–°ç‰ˆï¼‰
local shiftLockEnabled = false
local shiftLockConnection = nil
local shiftLockUI = nil
local lockMode = "none"  -- "none", "shiftlock", "nearest", "click"
local lockRotCon = nil
local lockTargetPlayer = nil
local lockMouseClickConn = nil
local lastLockMode = "none"  -- è¨˜éŒ„é˜²åç¹å•Ÿå‹•å‰çš„é–å®šæ¨¡å¼
local lastClickTime = 0
local lastClickedPlayer = nil

-- ====================
-- æ ¸å¿ƒè®Šæ•¸èˆ‡å‚™ä»½
-- ====================

-- é–å®šæœ€åŸå§‹çš„å…‰ç…§è¨­å®š
local trueLightingBackup = {
    Ambient = Lighting.Ambient,
    OutdoorAmbient = Lighting.OutdoorAmbient,
    Brightness = Lighting.Brightness,
    ColorShift_Bottom = Lighting.ColorShift_Bottom,
    ColorShift_Top = Lighting.ColorShift_Top,
    FogEnd = Lighting.FogEnd
}

-- åˆå§‹è§’è‰²æ•¸å€¼
local originalSpeed = 16
local hasOriginalValues = false

-- åŠŸèƒ½ç‹€æ…‹é–‹é—œ
local toggles = {
    speed = false,
    fullbright = false,
    cameraDist = false,
    nofog = false,
    noFilter = false,
    counterEvade = false,  -- æ”¹åç‚º counterEvade
    generatorESP = false,
    itemESP = false,
    autoInvisible = false,
    counterEvadeMode = "disguise"  -- "disguise" æˆ– "fullpower"
}

-- æ•¸å€¼è¨­å®š
local values = {
    speed = 34,
    fullbright = 1,
    cameraDist = 80,
    evadeRange = 15,
    evadeSpeed = 30,
    minDistance = 3  -- æœ€å°è·é›¢
}

-- é€£ç·šå„²å­˜
local connections = {
    speed = nil,
    fullbright = nil,
    nofog = nil,
    noFilter = nil,
    counterEvade = nil,  -- æ”¹å
    generatorESP = nil,
    itemESP = nil,
    autoInvisible = nil
}

-- ESP é¡¯ç¤ºç·©å­˜
local espObjects = {
    generators = {},
    items = {}
}

-- é˜²åç¹ç³»çµ±è®Šæ•¸
local isCounterEvading = false
local lastCounterEvadeTime = 0
local counterEvadeCooldown = 1
local lockedTarget = nil
local targetLockStartTime = 0
local manualLockedTarget = nil  -- æ‰‹å‹•é›™æ“Šé–å®šçš„ç›®æ¨™
local isFleeingFromDanger = false  -- æ˜¯å¦æ­£åœ¨é€ƒé›¢å±éšªç›®æ¨™

-- ====================
-- ShiftLock ç³»çµ±ï¼ˆæ–°ç‰ˆ - åŒ…å«å¤šç¨®é–å®šæ¨¡å¼ï¼‰
-- ====================

-- æ¸…é™¤æ‰€æœ‰é–å®šæ¨¡å¼
local function clearAllLockModes()
    if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
    if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum.AutoRotate = true end
    end
    
    lockMode = "none"
    shiftLockEnabled = false
    lockTargetPlayer = nil
    lastClickedPlayer = nil
end

-- è¨­ç½®é¢å‘æ—‹è½‰
local function setFaceRotation(type, target)
    if lockRotCon then lockRotCon:Disconnect() end
    
    local char = player.Character
    if not char then return end
    
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hum then return end
    
    hum.AutoRotate = false
    
    lockRotCon = RunService.RenderStepped:Connect(function()
        local myChar = player.Character
        if not myChar then return end
        
        local myHRP = myChar:FindFirstChild("HumanoidRootPart")
        if not myHRP then return end
        
        -- ç²å–è‡ªå·±çš„æœ€å¤§è¡€é‡
        local myMaxHealth = 0
        local myHumanoid = myChar:FindFirstChildOfClass("Humanoid")
        if myHumanoid then
            myMaxHealth = myHumanoid.MaxHealth
        end
        
        local lookAtPos = nil
        
        if type == "nearest" then
            local nearest, minDist = nil, math.huge
            for _, p in ipairs(Players:GetPlayers()) do
                if p ~= player and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                    local pRoot = p.Character.HumanoidRootPart
                    local pHumanoid = p.Character:FindFirstChildOfClass("Humanoid")
                    
                    local canTarget = true
                    if pHumanoid then
                        local pMaxHealth = pHumanoid.MaxHealth
                        
                        -- è¡€é‡åˆ¤å®šï¼šå¦‚æœå°æ–¹è¡€é‡>5000 ä¸” è‡ªå·±è¡€é‡<=3000ï¼Œè·³éé€™å€‹ç›®æ¨™
                        if pMaxHealth > 5000 and myMaxHealth <= 3000 then
                            canTarget = false
                        end
                    end
                    
                    if canTarget then
                        local d = (myHRP.Position - pRoot.Position).Magnitude
                        if d < minDist then 
                            minDist = d
                            nearest = pRoot 
                        end
                    end
                end
            end
            if nearest then lookAtPos = nearest.Position end
            
        elseif type == "click" and target and target.Character then
            local pRoot = target.Character:FindFirstChild("HumanoidRootPart")
            if pRoot then lookAtPos = pRoot.Position end
            
        elseif type == "shiftlock" then
            local cam = Workspace.CurrentCamera
            if cam then
                local lv = cam.CFrame.LookVector
                lookAtPos = myHRP.Position + Vector3.new(lv.X, 0, lv.Z)
            end
        end
        
        if lookAtPos then
            local flatDir = (lookAtPos - myHRP.Position) * Vector3.new(1, 0, 1)
            if flatDir.Magnitude > 0.001 then
                myHRP.CFrame = CFrame.lookAt(myHRP.Position, myHRP.Position + flatDir.Unit, Vector3.yAxis)
            end
        end
    end)
end

-- å•Ÿç”¨ ShiftLock
local function enableShiftLock()
    if lockMode == "shiftlock" then return end
    
    clearAllLockModes()
    lockMode = "shiftlock"
    shiftLockEnabled = true
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
    end
    
    setFaceRotation("shiftlock")
end

-- ç¦ç”¨æ‰€æœ‰é–å®šï¼ˆåƒ…ä¾›é˜²åç¹ä½¿ç”¨ï¼‰
local function disableAllLocksForCounterEvade()
    lastLockMode = lockMode  -- è¨˜éŒ„ç•¶å‰æ¨¡å¼
    if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
    if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
    
    if UserInputService.MouseEnabled then
        UserInputService.MouseBehavior = Enum.MouseBehavior.Default
    end
    
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then hum.AutoRotate = true end
    end
end

-- æ¢å¾©é˜²åç¹å‰çš„é–å®šæ¨¡å¼
local function restoreLockMode()
    if lastLockMode == "none" then
        return
    end
    
    task.wait(0.1)
    
    if lastLockMode == "shiftlock" then
        lockMode = "shiftlock"
        shiftLockEnabled = true
        if UserInputService.MouseEnabled then
            UserInputService.MouseBehavior = Enum.MouseBehavior.LockCenter
        end
        setFaceRotation("shiftlock")
        
    elseif lastLockMode == "nearest" then
        lockMode = "nearest"
        setFaceRotation("nearest")
        
    elseif lastLockMode == "click" and lockTargetPlayer then
        lockMode = "click"
        setFaceRotation("click", lockTargetPlayer)
    end
end

-- ====================
-- æ ¸å¿ƒé‚è¼¯å‡½æ•¸
-- ====================

-- ç²å–åˆå§‹å€¼
local function getOriginalValues()
    if toggles.speed then return end
    
    local character = player.Character
    if character then
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        if humanoid then
            originalSpeed = humanoid.WalkSpeed
        end
    end
    hasOriginalValues = true
end

-- æ™ºèƒ½å…‰ç…§ç®¡ç†å™¨
local function updateLighting()
    if toggles.fullbright then
        if connections.fullbright then connections.fullbright:Disconnect() end
        
        connections.fullbright = RunService.RenderStepped:Connect(function()
            local ambientValue = math.min(values.fullbright, 99)
            Lighting.Ambient = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.Brightness = values.fullbright
            Lighting.ColorShift_Bottom = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.ColorShift_Top = Color3.new(ambientValue, ambientValue, ambientValue)
            Lighting.OutdoorAmbient = Color3.new(ambientValue, ambientValue, ambientValue)
        end)
    else
        if connections.fullbright then connections.fullbright:Disconnect() end
        
        Lighting.Ambient = trueLightingBackup.Ambient
        Lighting.Brightness = trueLightingBackup.Brightness
        Lighting.OutdoorAmbient = trueLightingBackup.OutdoorAmbient
        Lighting.ColorShift_Bottom = trueLightingBackup.ColorShift_Bottom
        Lighting.ColorShift_Top = trueLightingBackup.ColorShift_Top
    end
end

-- æ‡‰ç”¨é€Ÿåº¦
local function applySpeed(char)
    if not char then char = player.Character end
    if not char then return end
    local hum = char:WaitForChild("Humanoid", 10)
    if not hum then return end

    if connections.speed then connections.speed:Disconnect() end
    
    if toggles.speed then
        hum.WalkSpeed = values.speed
        connections.speed = hum:GetPropertyChangedSignal("WalkSpeed"):Connect(function()
            if toggles.speed then hum.WalkSpeed = values.speed end
        end)
    else
        hum.WalkSpeed = originalSpeed
    end
end

-- ====================
-- é˜²åç¹ç³»çµ±ï¼ˆæ®ºæ‰‹æ¨¡å¼ï¼‰- ç°¡åŒ–ç‰ˆ
-- ====================

-- å°‹æ‰¾æœ€è¿‘ç©å®¶å‡½æ•¸ï¼ˆæ”¯æ´é–å®šï¼‰- æ·»åŠ è¡€é‡åˆ¤å®šå’Œæ‰‹å‹•é–å®š
local function findNearestPlayer()
    local char = player.Character
    if not char then return nil, math.huge end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, math.huge end
    
    -- ç²å–è‡ªå·±çš„æœ€å¤§è¡€é‡
    local myMaxHealth = 0
    local myHumanoid = char:FindFirstChildOfClass("Humanoid")
    if myHumanoid then
        myMaxHealth = myHumanoid.MaxHealth
    end
    
    -- â˜… å„ªå…ˆä½¿ç”¨æ‰‹å‹•é–å®šç›®æ¨™ï¼ˆä¸å—ä»»ä½•æ™‚é–“æˆ–è·é›¢é™åˆ¶ï¼‰
    if manualLockedTarget then
        if manualLockedTarget.Character then
            local targetHRP = manualLockedTarget.Character:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = manualLockedTarget.Character:FindFirstChildOfClass("Humanoid")
            
            if targetHumanoid and targetHumanoid.Health > 0 and targetHRP then
                local distance = (hrp.Position - targetHRP.Position).Magnitude
                return manualLockedTarget, distance
            else
                -- ç›®æ¨™è¡€é‡ç‚º0ï¼Œè§£é™¤æ‰‹å‹•é–å®š
                print("ğŸ¯ æ‰‹å‹•é–å®šç›®æ¨™å·²æ­»äº¡ï¼ˆè¡€é‡ç‚º0ï¼‰ï¼Œè§£é™¤é–å®š")
                manualLockedTarget = nil
                lockedTarget = nil
                return nil, math.huge
            end
        else
            manualLockedTarget = nil
            lockedTarget = nil
            return nil, math.huge
        end
    end
    
    -- â˜… è‡ªå‹•é–å®šç›®æ¨™ï¼šåªè¦ç›®æ¨™å­˜æ´»å°±æŒçºŒè¿½ï¼ˆä¸è¨­æ™‚é–“é™åˆ¶ï¼‰
    if lockedTarget then
        if lockedTarget.Character then
            local targetHRP = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            local targetHumanoid = lockedTarget.Character:FindFirstChildOfClass("Humanoid")
            
            if targetHumanoid and targetHumanoid.Health > 0 and targetHRP then
                local distance = (hrp.Position - targetHRP.Position).Magnitude
                
                -- è¡€é‡åˆ¤å®šï¼šå¦‚æœç›®æ¨™è¡€é‡>5000 ä¸” è‡ªå·±è¡€é‡<=3000ï¼Œæ”¾æ£„é–å®šä¸¦å°‹æ‰¾å…¶ä»–ç›®æ¨™
                if targetHumanoid.MaxHealth > 5000 and myMaxHealth <= 3000 then
                    lockedTarget = nil
                    -- ä¸ç›´æ¥ returnï¼Œè®“ä¸‹é¢ç¹¼çºŒæ‰¾æœ€è¿‘çš„ç©å®¶
                else
                    return lockedTarget, distance
                end
            else
                -- ç›®æ¨™è¡€é‡ç‚º0ï¼Œæ¸…é™¤é–å®šä¸¦å°‹æ‰¾æ–°ç›®æ¨™
                print("ğŸ¯ è‡ªå‹•é–å®šç›®æ¨™å·²æ­»äº¡ï¼ˆè¡€é‡ç‚º0ï¼‰ï¼Œé‡æ–°å°‹æ‰¾")
                lockedTarget = nil
            end
        else
            lockedTarget = nil
        end
    end
    
    -- æ²’æœ‰é–å®šç›®æ¨™æ™‚ï¼Œå°‹æ‰¾æœ€è¿‘çš„ç©å®¶ä¸¦é–å®š
    local nearestPlayer = nil
    local minDistance = math.huge
    local currentTime = tick()
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer ~= player and otherPlayer.Character then
            local otherHRP = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            local otherHumanoid = otherPlayer.Character:FindFirstChildOfClass("Humanoid")
            
            if otherHRP and otherHumanoid and otherHumanoid.Health > 0 then
                -- è¡€é‡åˆ¤å®š
                local canTarget = not (otherHumanoid.MaxHealth > 5000 and myMaxHealth <= 3000)
                
                if canTarget then
                    local distance = (hrp.Position - otherHRP.Position).Magnitude
                    if distance < minDistance then
                        minDistance = distance
                        nearestPlayer = otherPlayer
                    end
                end
            end
        end
    end
    
    -- é–å®šæ‰¾åˆ°çš„æ–°ç›®æ¨™
    if nearestPlayer then
        lockedTarget = nearestPlayer
        targetLockStartTime = currentTime
    end
    
    return nearestPlayer, minDistance
end

-- æª¢æ¸¬ç›®æ¨™æ˜¯å¦ç‚ºå±éšªç›®æ¨™
local function isDangerousTarget(targetPlayer)
    if not targetPlayer or not targetPlayer.Character then
        return false
    end
    
    local humanoid = targetPlayer.Character:FindFirstChildOfClass("Humanoid")
    if not humanoid then
        return false
    end
    
    local parentName = humanoid.Parent and humanoid.Parent.Name or ""
    local speed = humanoid.WalkSpeed
    
    -- èª¿è©¦ä¿¡æ¯
    -- print(string.format("æª¢æ¸¬ç›®æ¨™: %s, Parent: %s, é€Ÿåº¦: %.1f", targetPlayer.Name, parentName, speed))
    
    -- æª¢æ¸¬ Shedletskyã€Chanceã€TwoTime ä¸”é€Ÿåº¦<5
    if (parentName == "Shedletsky" or parentName == "Chance" or parentName == "TwoTime") then
        if speed < 5 then
            print(string.format("âš ï¸ å±éšªç›®æ¨™æª¢æ¸¬: %s (Parent: %s, é€Ÿåº¦: %.1f < 5)", targetPlayer.Name, parentName, speed))
            return true
        end
    end
    
    -- æª¢æ¸¬ Guest1337 ä¸”é€Ÿåº¦=4.8æˆ–10.4
    if parentName == "Guest1337" then
        if math.abs(speed - 4.8) < 0.1 or math.abs(speed - 10.4) < 0.1 then
            print(string.format("âš ï¸ å±éšªç›®æ¨™æª¢æ¸¬: %s (Parent: %s, é€Ÿåº¦: %.1f)", targetPlayer.Name, parentName, speed))
            return true
        end
    end
    
    return false
end

-- é€ƒé›¢å±éšªç›®æ¨™
local function fleeFromDangerousTarget(targetPlayer)
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    local targetHRP = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    isFleeingFromDanger = true
    
    -- ç¦ç”¨æ‰€æœ‰é–å®š
    disableAllLocksForCounterEvade()
    
    task.spawn(function()
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(100000, 0, 100000)
        bodyVelocity.P = 10000
        bodyVelocity.Parent = hrp
        
        humanoid.AutoRotate = false
        
        -- è¨ˆç®—é€ƒé›¢æ–¹å‘ï¼ˆèƒŒé›¢ç›®æ¨™ï¼‰
        local fleeDirection = (hrp.Position - targetHRP.Position).Unit
        
        -- é€ƒé›¢1.5ç§’
        local fleeTime = 1.5
        local fleeSteps = math.ceil(fleeTime / 0.03)
        
        for i = 1, fleeSteps do
            if not isFleeingFromDanger then break end
            
            bodyVelocity.Velocity = fleeDirection * values.evadeSpeed
            
            local lookDirection = fleeDirection * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        bodyVelocity:Destroy()
        humanoid.AutoRotate = true
        
        isFleeingFromDanger = false
        
        -- æ¢å¾©é–å®š
        restoreLockMode()
    end)
end

-- åŸ·è¡Œé˜²åç¹å‹•ä½œï¼ˆæ®ºæ‰‹è¿½æ“Šç©å®¶ï¼‰
local function performCounterEvade()
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    local targetPlayer, distance = findNearestPlayer()
    if not targetPlayer then return end
    if distance > values.evadeRange then return end
    
    -- ã€æ–°å¢ã€‘æª¢æ¸¬å±éšªç›®æ¨™
    if isDangerousTarget(targetPlayer) then
        print("âš ï¸ æª¢æ¸¬åˆ°å±éšªç›®æ¨™ï¼Œè‡ªå‹•é€ƒé›¢ï¼")
        -- æ¸…é™¤æ‰€æœ‰é–å®š
        lockedTarget = nil
        manualLockedTarget = nil
        -- ç«‹å³é€ƒé›¢
        fleeFromDangerousTarget(targetPlayer)
        return
    end
    
    -- ã€æ–°å¢ã€‘æª¢æŸ¥æœ€å°è·é›¢ï¼Œå¦‚æœå·²ç¶“å¤ è¿‘å°±ä¸è¿½äº†
    if distance <= values.minDistance then
        return
    end
    
    -- æª¢æŸ¥æ˜¯å¦æœ‰éšœç¤™ç‰©é˜»æ“‹
    local targetHRP = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {char, targetPlayer.Character}
    
    local directionToTarget = targetHRP.Position - hrp.Position
    local rayResult = Workspace:Raycast(hrp.Position, directionToTarget, params)
    
    if rayResult then
        return  -- æª¢æ¸¬åˆ°éšœç¤™ç‰©ï¼Œæš«åœè¿½æ“Šï¼ˆä¸é€²å†·å»ï¼‰
    end
    
    -- æª¢æŸ¥å†·å»æ™‚é–“
    local currentTime = tick()
    if toggles.counterEvadeMode == "disguise" then
        if currentTime - lastCounterEvadeTime < 5 then return end
    end
    
    isCounterEvading = true
    lastCounterEvadeTime = currentTime
    
    -- ã€æ–°å¢ã€‘ç¦ç”¨æ‰€æœ‰é–å®šåŠŸèƒ½ï¼ˆä¿ç•™ ESPï¼‰
    disableAllLocksForCounterEvade()
    
    -- ä¿å­˜åŸå§‹é€Ÿåº¦
    local originalWalkSpeed = humanoid.WalkSpeed
    local wasSpeedActive = toggles.speed
    
    -- å¦‚æœé€Ÿåº¦åŠŸèƒ½é–‹å•Ÿï¼Œå…ˆé—œé–‰å®ƒ
    if toggles.speed then
        toggles.speed = false
        if connections.speed then connections.speed:Disconnect() end
        humanoid.WalkSpeed = originalSpeed
    end
    
    task.spawn(function()
        local targetHRP = targetPlayer.Character and targetPlayer.Character:FindFirstChild("HumanoidRootPart")
        if not targetHRP then
            isCounterEvading = false
            -- ã€æ–°å¢ã€‘æ¢å¾©é–å®š
            restoreLockMode()
            return
        end
        
        -- ä½¿ç”¨ BodyVelocity æ§åˆ¶ç§»å‹•
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(100000, 0, 100000)
        bodyVelocity.P = 10000
        bodyVelocity.Parent = hrp
        
        humanoid.AutoRotate = false
        
        local duration = toggles.counterEvadeMode == "disguise" and 3 or 1
        local steps = math.ceil(duration / 0.03)

        -- å½è£æ¨¡å¼: ç›£æ§é€Ÿåº¦æ˜¯å¦è¢«è¨­ç‚ºå°æ–¼5
        local isDisguiseMode = toggles.counterEvadeMode == "disguise"
        
        -- æ”¹é€²çš„ç¢°å£æª¢æ¸¬è®Šæ•¸
        local lastPosition = hrp.Position
        local stuckCheckInterval = 0.2
        local lastCheckTime = tick()
        local forwardMoveThreshold = 5  -- å‰æ–¹ç§»å‹•è·é›¢é–¾å€¼
        local consecutiveStuckCount = 0
        local maxStuckCount = 3
        
        -- æ”¹é€²çš„ç›®æ¨™æ›æ©Ÿæª¢æ¸¬
        local lastTargetPosition = targetHRP.Position
        local targetStuckCount = 0
        local maxTargetStuckCount = 8  -- å¢åŠ åˆ°8æ¬¡æ‰åˆ¤å®šç‚ºæ›æ©Ÿ
        local targetMoveThreshold = 2  -- ç›®æ¨™ç§»å‹•è·é›¢é–¾å€¼å¢åŠ åˆ°2
        local targetCirclingDetection = {}  -- ç¹åœˆæª¢æ¸¬
        local circlingCheckCount = 0
        
        -- ã€æ–°å¢ã€‘æœ€å°è·é›¢ç›¸é—œè®Šæ•¸
        local reachedMinDistance = false  -- æ˜¯å¦å·²åˆ°é”æœ€å°è·é›¢
        local lastDistanceCheckTime = tick()
        local distanceCheckInterval = 0.2  -- æ¯0.2ç§’æª¢æŸ¥ä¸€æ¬¡è·é›¢
        
        -- ã€æ–°å¢ã€‘å±éšªç›®æ¨™æ¨™å¿—
        local detectedDangerousTarget = false
        
        for i = 1, steps do
            if not isCounterEvading or not toggles.counterEvade then
                break
            end
            
            -- ã€æ–°å¢ã€‘æŒçºŒæª¢æ¸¬å±éšªç›®æ¨™
            if isDangerousTarget(targetPlayer) then
                print("âš ï¸ è¿½æ“Šä¸­æª¢æ¸¬åˆ°å±éšªç›®æ¨™ï¼Œç«‹å³é€ƒé›¢ï¼")
                lockedTarget = nil
                manualLockedTarget = nil
                detectedDangerousTarget = true
                break
            end
            
            -- ã€ä¿®æ”¹ã€‘æœ€å°è·é›¢æª¢æ¸¬ï¼šå¦‚æœå·²åˆ°é”æœ€å°è·é›¢ï¼Œæª¢æ¸¬ç›®æ¨™æ˜¯å¦ç§»å‹•
            local currentDistance = (hrp.Position - targetHRP.Position).Magnitude
            local currentTime = tick()
            
            if currentDistance <= values.minDistance then
                if not reachedMinDistance then
                    -- ç¬¬ä¸€æ¬¡åˆ°é”æœ€å°è·é›¢
                    reachedMinDistance = true
                    lastTargetPosition = targetHRP.Position
                    lastDistanceCheckTime = currentTime
                end
                
                -- æª¢æŸ¥ç›®æ¨™æ˜¯å¦ç§»å‹•
                if currentTime - lastDistanceCheckTime >= distanceCheckInterval then
                    local targetMoved = (targetHRP.Position - lastTargetPosition).Magnitude
                    
                    if targetMoved < 1 then
                        -- ç›®æ¨™æ²’ç§»å‹•ï¼Œåœæ­¢è¿½æ“Š
                        break
                    else
                        -- ç›®æ¨™ç§»å‹•äº†ï¼Œç¹¼çºŒè¿½æ“Š
                        reachedMinDistance = false
                        lastTargetPosition = targetHRP.Position
                        lastDistanceCheckTime = currentTime
                    end
                end
            else
                -- è·é›¢å¤§æ–¼æœ€å°è·é›¢ï¼Œé‡ç½®æ¨™è¨˜
                reachedMinDistance = false
            end
            
            -- å½è£æ¨¡å¼: æª¢æŸ¥é€Ÿåº¦æ˜¯å¦å°æ–¼5
            if isDisguiseMode and humanoid.WalkSpeed < 5 then
                lastCounterEvadeTime = tick()  -- ç«‹å³é€²å…¥å†·å»(5ç§’)
                break
            end
            
            -- æ”¹é€²çš„ç¢°å£æª¢æ¸¬ï¼šæª¢æ¸¬å‰æ–¹æ˜¯å¦æœ‰éšœç¤™ç‰© + å‰æ–¹ç§»å‹•è·é›¢
            local currentTime = tick()
            if currentTime - lastCheckTime >= stuckCheckInterval then
                -- è¨ˆç®—é¢å‘æ–¹å‘çš„ç§»å‹•è·é›¢
                local moveVector = hrp.Position - lastPosition
                local lookDirection = hrp.CFrame.LookVector
                local forwardMovement = moveVector:Dot(lookDirection)  -- å‰æ–¹ç§»å‹•åˆ†é‡
                
                -- æª¢æ¸¬å‰æ–¹æ˜¯å¦æœ‰éšœç¤™ç‰©
                local rayParams = RaycastParams.new()
                rayParams.FilterType = Enum.RaycastFilterType.Blacklist
                rayParams.FilterDescendantsInstances = {char, targetPlayer.Character}
                
                local forwardRay = Workspace:Raycast(hrp.Position, lookDirection * 10, rayParams)
                local hasObstacleAhead = forwardRay ~= nil and forwardRay.Distance < 5
                
                -- å¦‚æœå‰æ–¹æœ‰éšœç¤™ç‰© ä¸” å‰æ–¹ç§»å‹•è·é›¢å°æ–¼5
                if hasObstacleAhead and forwardMovement < forwardMoveThreshold then
                    consecutiveStuckCount = consecutiveStuckCount + 1
                    if consecutiveStuckCount >= maxStuckCount then
                        -- ç©å®¶ç¢°å£ï¼Œæš«åœé˜²åç¹
                        break
                    end
                else
                    consecutiveStuckCount = 0
                end
                
                -- æ”¹é€²çš„ç›®æ¨™æ›æ©Ÿæª¢æ¸¬
                local targetDistanceMoved = (targetHRP.Position - lastTargetPosition).Magnitude
                
                if targetDistanceMoved < targetMoveThreshold then
                    targetStuckCount = targetStuckCount + 1
                    
                    -- åŒæ™‚æª¢æ¸¬æ˜¯å¦åœ¨ç¹åœˆï¼ˆç©å®¶å’Œç›®æ¨™è·é›¢è®ŠåŒ–å¾ˆå°ï¼‰
                    local currentDistance = (hrp.Position - targetHRP.Position).Magnitude
                    table.insert(targetCirclingDetection, currentDistance)
                    
                    if #targetCirclingDetection > 5 then
                        table.remove(targetCirclingDetection, 1)
                        
                        -- è¨ˆç®—è·é›¢è®ŠåŒ–
                        local minDist = math.huge
                        local maxDist = -math.huge
                        for _, dist in ipairs(targetCirclingDetection) do
                            minDist = math.min(minDist, dist)
                            maxDist = math.max(maxDist, dist)
                        end
                        
                        -- å¦‚æœè·é›¢è®ŠåŒ–å°æ–¼3ï¼ˆåœ¨ç¹åœˆï¼‰
                        if (maxDist - minDist) < 3 then
                            circlingCheckCount = circlingCheckCount + 1
                            if circlingCheckCount >= 3 then
                                -- æª¢æ¸¬åˆ°ç¹åœˆï¼Œæš«åœé˜²åç¹
                                break
                            end
                        else
                            circlingCheckCount = 0
                        end
                    end
                    
                    -- å¦‚æœç›®æ¨™é•·æ™‚é–“ä¸å‹•
                    if targetStuckCount >= maxTargetStuckCount then
                        -- ç›®æ¨™æ›æ©Ÿï¼Œæš«åœé˜²åç¹
                        break
                    end
                else
                    targetStuckCount = 0
                    circlingCheckCount = 0
                    targetCirclingDetection = {}
                end
                
                lastPosition = hrp.Position
                lastTargetPosition = targetHRP.Position
                lastCheckTime = currentTime
            end

            -- æŒçºŒè¿½æ“Šé–å®šçš„ç›®æ¨™
            if lockedTarget and lockedTarget.Character then
                targetHRP = lockedTarget.Character:FindFirstChild("HumanoidRootPart")
            end
            
            if not targetHRP then break end
            
            -- è¨ˆç®—æ–¹å‘
            local direction = (targetHRP.Position - hrp.Position).Unit
            bodyVelocity.Velocity = direction * values.evadeSpeed
            
            -- é¢å‘ç›®æ¨™
            local lookDirection = direction * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        -- æ¸…ç†
        bodyVelocity:Destroy()
        humanoid.AutoRotate = true
        
        -- ã€æ–°å¢ã€‘æª¢æŸ¥æ˜¯å¦éœ€è¦é€ƒé›¢å±éšªç›®æ¨™ï¼ˆä½¿ç”¨æ¨™å¿—æˆ–é‡æ–°æª¢æ¸¬ï¼‰
        if detectedDangerousTarget or isDangerousTarget(targetPlayer) then
            print("âš ï¸ æª¢æ¸¬åˆ°å±éšªç›®æ¨™ï¼Œé–‹å§‹é€ƒé›¢ï¼")
            -- æ¢å¾©é€Ÿåº¦è¨­ç½®
            if wasSpeedActive then
                toggles.speed = true
                applySpeed()
            else
                humanoid.WalkSpeed = originalSpeed
            end
            
            isCounterEvading = false
            
            -- åŸ·è¡Œé€ƒé›¢
            fleeFromDangerousTarget(targetPlayer)
            return
        end
        
        -- æ¢å¾©é€Ÿåº¦è¨­ç½®
        if wasSpeedActive then
            toggles.speed = true
            applySpeed()
        else
            humanoid.WalkSpeed = originalSpeed
        end
        
        -- ã€æ–°å¢ã€‘æ¢å¾©é–å®šåŠŸèƒ½
        restoreLockMode()
        
        isCounterEvading = false
    end)
end

-- é˜²åç¹ç›£æ§
local function startCounterEvade()
    if connections.counterEvade then connections.counterEvade:Disconnect() end
    
    if toggles.counterEvade then
        connections.counterEvade = RunService.Heartbeat:Connect(function()
            if not isCounterEvading then
                performCounterEvade()
            end
        end)
    else
        if connections.counterEvade then
            connections.counterEvade:Disconnect()
            connections.counterEvade = nil
        end
    end
end

-- ====================
-- ESP é¡¯ç¤ºç³»çµ±
-- ====================

-- å‰µå»º ESP é«˜äº®æ¡†
local function createESPBox(part, color, itemType)
    -- å‰µå»º BoxHandleAdornment
    local box = Instance.new("BoxHandleAdornment")
    box.Name = "ESPBox"
    box.Adornee = part
    box.Size = part.Size
    box.Color3 = color
    box.AlwaysOnTop = true
    box.ZIndex = 10
    box.Transparency = 0.7
    box.Parent = part
    
    -- å‰µå»º BillboardGui é¡¯ç¤ºè·é›¢å’Œé€²åº¦
    local billboard = Instance.new("BillboardGui")
    billboard.Name = "ESPLabel"
    billboard.Adornee = part
    billboard.Size = UDim2.new(0, 100, 0, 60)
    billboard.StudsOffset = Vector3.new(0, 2, 0)
    billboard.AlwaysOnTop = true
    billboard.Parent = part
    
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.TextColor3 = color
    label.TextStrokeTransparency = 0.5
    label.TextSize = 14
    label.Font = Enum.Font.GothamBold
    label.Parent = billboard
    
    -- æ›´æ–°è·é›¢å’Œé€²åº¦é¡¯ç¤º
    local updateConnection
    updateConnection = RunService.RenderStepped:Connect(function()
        if not part or not part.Parent then
            updateConnection:Disconnect()
            return
        end
        
        local char = player.Character
        if char then
            local hrp = char:FindFirstChild("HumanoidRootPart")
            if hrp then
                local distance = (part.Position - hrp.Position).Magnitude
                
                -- å¦‚æœæ˜¯ç™¼é›»æ©Ÿï¼Œé¡¯ç¤ºé€²åº¦
                if itemType == "generator" then
                    local mainParent = part.Parent
                    local progress = mainParent and mainParent:FindFirstChild("Progress")
                    local progressValue = progress and progress.Value or 0
                    label.Text = string.format("%.1fm\né€²åº¦: %.1f%%", distance, progressValue)
                else
                    label.Text = string.format("%.1fm", distance)
                end
            end
        end
    end)
    
    return box, billboard, updateConnection
end

-- æ¸…é™¤æŒ‡å®šé¡å‹çš„ ESP
local function clearESP(espType)
    for _, espData in pairs(espObjects[espType]) do
        if espData.box then espData.box:Destroy() end
        if espData.billboard then espData.billboard:Destroy() end
        if espData.connection then espData.connection:Disconnect() end
    end
    espObjects[espType] = {}
end

-- æª¢æŸ¥ç‰©å“è·¯å¾‘æ˜¯å¦åŒ…å« itemrootï¼ˆä¸å€åˆ†å¤§å°å¯«ï¼‰
local function isItemInPath(obj)
    local current = obj
    while current do
        if current.Name:lower() == "itemroot" then
            return true
        end
        current = current.Parent
    end
    return false
end

-- æª¢æŸ¥ç™¼é›»æ©Ÿæ˜¯å¦ç¬¦åˆæ¢ä»¶ï¼ˆè·¯å¾‘åŒ…å«Mainä¸”æœ‰Promptï¼Œä½†æ’é™¤FakeGeneratorï¼‰
local function isValidGenerator(obj)
    -- æª¢æŸ¥è·¯å¾‘æ˜¯å¦åŒ…å« Main
    local hasMain = false
    local mainObject = nil
    local current = obj
    while current do
        if current.Name == "Main" then
            hasMain = true
            mainObject = current
            break
        end
        current = current.Parent
    end
    
    if not hasMain or not mainObject then return false end
    
    -- æª¢æŸ¥ Main çš„ Parent æ˜¯å¦ç‚º FakeGeneratorï¼ˆæ’é™¤å‡ç™¼é›»æ©Ÿï¼‰
    if mainObject.Parent and mainObject.Parent.Name == "FakeGenerator" then
        return false
    end
    
    -- æª¢æŸ¥æ˜¯å¦æœ‰ Prompt
    local hasPrompt = false
    for _, child in pairs(obj:GetDescendants()) do
        if child:IsA("ProximityPrompt") then
            hasPrompt = true
            break
        end
    end
    
    return hasPrompt
end

-- ç™¼é›»æ©Ÿ ESP
local function updateGeneratorESP()
    clearESP("generators")
    
    if not toggles.generatorESP then return end
    
    -- éæ­·æ•´å€‹ Workspaceï¼Œå°‹æ‰¾ç¬¦åˆæ¢ä»¶çš„ç™¼é›»æ©Ÿ
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and isValidGenerator(obj) then
            local box, billboard, connection = createESPBox(obj, Color3.fromRGB(0, 255, 0), "generator")
            table.insert(espObjects.generators, {
                part = obj,
                box = box,
                billboard = billboard,
                connection = connection
            })
        end
    end
end

-- ç‰©å“ ESP
local function updateItemESP()
    clearESP("items")
    
    if not toggles.itemESP then return end
    
    -- éæ­·æ•´å€‹ Workspaceï¼Œå°‹æ‰¾è·¯å¾‘åŒ…å« itemroot çš„ç‰©å“
    for _, obj in pairs(Workspace:GetDescendants()) do
        if obj:IsA("BasePart") and isItemInPath(obj) then
            local box, billboard, connection = createESPBox(obj, Color3.fromRGB(255, 255, 0), "item")
            table.insert(espObjects.items, {
                part = obj,
                box = box,
                billboard = billboard,
                connection = connection
            })
        end
    end
end

-- ç›£æ§æ–°ç”Ÿæˆçš„ç‰©å“å’Œç™¼é›»æ©Ÿ
local function startItemMonitoring()
    if connections.itemESP then connections.itemESP:Disconnect() end
    
    if toggles.itemESP then
        connections.itemESP = Workspace.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("BasePart") and isItemInPath(descendant) then
                task.wait(0.1)
                if toggles.itemESP then
                    local box, billboard, connection = createESPBox(descendant, Color3.fromRGB(255, 255, 0), "item")
                    table.insert(espObjects.items, {
                        part = descendant,
                        box = box,
                        billboard = billboard,
                        connection = connection
                    })
                end
            end
        end)
    end
end

-- ç›£æ§æ–°ç”Ÿæˆçš„ç™¼é›»æ©Ÿ
local function startGeneratorMonitoring()
    if connections.generatorESP then connections.generatorESP:Disconnect() end
    
    if toggles.generatorESP then
        connections.generatorESP = Workspace.DescendantAdded:Connect(function(descendant)
            if descendant:IsA("BasePart") then
                task.wait(0.1)
                if toggles.generatorESP and isValidGenerator(descendant) then
                    local box, billboard, connection = createESPBox(descendant, Color3.fromRGB(0, 255, 0), "generator")
                    table.insert(espObjects.generators, {
                        part = descendant,
                        box = box,
                        billboard = billboard,
                        connection = connection
                    })
                end
            end
        end)
    end
end

-- é‡ç”Ÿç›£è½
player.CharacterAdded:Connect(function(newChar)
    task.wait(0.5)
    if toggles.speed then applySpeed(newChar) end
    lastCounterEvadeTime = 0
    isCounterEvading = false
end)

-- ====================
-- è‡ªå‹•éš±å½¢ç³»çµ±ï¼ˆç°¡åŒ–ç‰ˆ - åªä¿ç•™ä¸€ç¨®è·¯å¾‘ï¼‰
-- ====================

local autoInvisToggles = {
    autoEvade = false
}

local autoInvisValues = {
    evadeRange = 15,
    evadeSpeed = 30
}

local autoInvisConnections = {
    autoEvade = nil
}

local isAutoInvisEvading = false
local lastAutoInvisEvadeTime = 0
local autoInvisEvadeCooldown = 1.5

-- å°‹æ‰¾æœ€è¿‘çš„ç©å®¶ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
local function findNearestPlayerForInvis()
    local char = player.Character
    if not char then return nil, math.huge end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil, math.huge end
    
    local nearestPlayer = nil
    local minDistance = math.huge
    
    for _, otherPlayer in pairs(Players:GetPlayers()) do
        if otherPlayer.Character then
            local otherHRP = otherPlayer.Character:FindFirstChild("HumanoidRootPart")
            if otherHRP then
                local distance = (hrp.Position - otherHRP.Position).Magnitude
                if distance < minDistance then
                    minDistance = distance
                    nearestPlayer = otherPlayer
                end
            end
        end
    end
    
    return nearestPlayer, minDistance
end

-- ç°¡åŒ–ç‰ˆåç¹ - åªä½¿ç”¨å·¦å¾Œæ–¹è·¯å¾‘
local function performSimpleEvade()
    local char = player.Character
    if not char then return end
    
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not humanoid then return end
    
    local targetPlayer, distance = findNearestPlayerForInvis()
    if not targetPlayer then return end
    if distance > autoInvisValues.evadeRange then return end
    
    local targetChar = targetPlayer.Character
    if not targetChar then return end
    
    local targetHRP = targetChar:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    -- æª¢æŸ¥æ˜¯å¦æœ‰éšœç¤™ç‰©é˜»æ“‹
    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {char, targetChar}
    
    local directionToTarget = targetHRP.Position - hrp.Position
    local rayResult = Workspace:Raycast(hrp.Position, directionToTarget, params)
    
    if rayResult then return end
    
    -- æª¢æŸ¥å†·å»æ™‚é–“
    local currentTime = tick()
    if currentTime - lastAutoInvisEvadeTime < autoInvisEvadeCooldown then return end
    
    isAutoInvisEvading = true
    lastAutoInvisEvadeTime = currentTime
    
    local originalAutoRotate = humanoid.AutoRotate
    local evadeRadius = autoInvisValues.evadeRange
    
    task.spawn(function()
        local bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.MaxForce = Vector3.new(100000, 0, 100000)
        bodyVelocity.P = 10000
        bodyVelocity.Parent = hrp
        
        humanoid.AutoRotate = false
        
        -- åªä½¿ç”¨å·¦å¾Œæ–¹åŠåœ“è·¯å¾‘
        local directionToTarget = (targetHRP.Position - hrp.Position).Unit
        local perpendicular = Vector3.new(-directionToTarget.Z, 0, directionToTarget.X)
        
        local startAngle = math.pi / 2
        local endAngle = math.pi * 1.5
        local centerPos = hrp.Position + perpendicular * evadeRadius
        
        local totalTime = (math.pi * evadeRadius) / autoInvisValues.evadeSpeed
        local steps = math.ceil(totalTime / 0.03)
        local stepAngle = (endAngle - startAngle) / steps
        
        for i = 1, steps do
            if not isAutoInvisEvading or not autoInvisToggles.autoEvade then break end
            
            local angle = startAngle + stepAngle * i
            local nextAngle = startAngle + stepAngle * (i + 1)
            
            local currentOffset = Vector3.new(
                math.cos(angle) * evadeRadius,
                0,
                math.sin(angle) * evadeRadius
            )
            local nextOffset = Vector3.new(
                math.cos(nextAngle) * evadeRadius,
                0,
                math.sin(nextAngle) * evadeRadius
            )
            
            local currentPoint = centerPos + currentOffset
            local nextPoint = centerPos + nextOffset
            
            local moveDirection = (nextPoint - currentPoint).Unit
            bodyVelocity.Velocity = moveDirection * autoInvisValues.evadeSpeed
            
            local lookDirection = moveDirection * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        -- åç¹å®Œæˆå¾Œç¹¼çºŒå‰é€²
        local finalDirection = (hrp.Position - targetHRP.Position).Unit
        local forwardDistance = evadeRadius
        local forwardTime = forwardDistance / autoInvisValues.evadeSpeed
        local forwardSteps = math.ceil(forwardTime / 0.03)
        
        for i = 1, forwardSteps do
            if not isAutoInvisEvading or not autoInvisToggles.autoEvade then break end
            
            bodyVelocity.Velocity = finalDirection * autoInvisValues.evadeSpeed
            
            local lookDirection = finalDirection * Vector3.new(1, 0, 1)
            if lookDirection.Magnitude > 0 then
                hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + lookDirection)
            end
            
            task.wait(0.03)
        end
        
        bodyVelocity:Destroy()
        humanoid.AutoRotate = originalAutoRotate
        isAutoInvisEvading = false
    end)
end

-- è‡ªå‹•éš±å½¢ç›£æ§
local function startAutoInvisible()
    if autoInvisConnections.autoEvade then autoInvisConnections.autoEvade:Disconnect() end
    
    if autoInvisToggles.autoEvade then
        autoInvisConnections.autoEvade = RunService.Heartbeat:Connect(function()
            if not isAutoInvisEvading then
                performSimpleEvade()
            end
        end)
    end
end

-- ====================
-- UI å»ºæ§‹
-- ====================
local screenGui = Instance.new("ScreenGui")
screenGui.Name = "SpeedJumpController"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Global
screenGui.DisplayOrder = 10001

local function parentUI(g)
    local success = pcall(function()
        if gethui then g.Parent = gethui()
        elseif CoreGui then g.Parent = CoreGui
        else g.Parent = playerGui end
    end)
    if not success then g.Parent = playerGui end
end
parentUI(screenGui)

-- ä¸»è¦–çª—
local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 260, 0, 262)
mainFrame.Position = UDim2.new(0.5, -130, 0.5, -131)
mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui
Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 10)

-- æ¨™é¡Œæ¬„
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 32)
titleBar.BackgroundColor3 = Color3.fromRGB(102, 126, 234)
titleBar.Parent = mainFrame
Instance.new("UICorner", titleBar).CornerRadius = UDim.new(0, 10)

local title = Instance.new("TextLabel")
title.Size = UDim2.new(1, -60, 1, 0)
title.BackgroundTransparency = 1
title.Text = "è²“ç²çš„é¬¼æŠ“äººéŠæˆ²æ§åˆ¶å™¨"
title.TextSize = 14
title.Font = Enum.Font.GothamBold
title.TextColor3 = Color3.fromRGB(255, 255, 255)
title.Parent = titleBar

local minimizeButton = Instance.new("TextButton")
minimizeButton.Size = UDim2.new(0, 24, 0, 24)
minimizeButton.Position = UDim2.new(1, -54, 0, 4)
minimizeButton.BackgroundColor3 = Color3.fromRGB(158, 158, 158)
minimizeButton.Text = "â”€"
minimizeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
minimizeButton.Parent = titleBar
Instance.new("UICorner", minimizeButton).CornerRadius = UDim.new(0, 5)

local closeButton = Instance.new("TextButton")
closeButton.Size = UDim2.new(0, 24, 0, 24)
closeButton.Position = UDim2.new(1, -28, 0, 4)
closeButton.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
closeButton.Text = "X"
closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
closeButton.Parent = titleBar
Instance.new("UICorner", closeButton).CornerRadius = UDim.new(0, 5)

-- åˆ†é ç³»çµ±ï¼ˆå¯æ©«å‘æ»¾å‹•ï¼‰
local tabBar = Instance.new("Frame")
tabBar.Size = UDim2.new(0.9, 0, 0, 28)
tabBar.Position = UDim2.new(0.05, 0, 0, 38)
tabBar.BackgroundColor3 = Color3.fromRGB(240, 240, 240)
tabBar.Parent = mainFrame
tabBar.ClipsDescendants = true
Instance.new("UICorner", tabBar).CornerRadius = UDim.new(0, 6)

-- å¯æ»¾å‹•çš„å…§éƒ¨å®¹å™¨
local tabScroll = Instance.new("ScrollingFrame")
tabScroll.Size = UDim2.new(1, 0, 1, 0)
tabScroll.BackgroundTransparency = 1
tabScroll.BorderSizePixel = 0
tabScroll.ScrollBarThickness = 0
tabScroll.ScrollingDirection = Enum.ScrollingDirection.X
tabScroll.CanvasSize = UDim2.new(0, 240, 0, 0)
tabScroll.Parent = tabBar

local tabLayout = Instance.new("UIListLayout")
tabLayout.FillDirection = Enum.FillDirection.Horizontal
tabLayout.Padding = UDim.new(0, 2)
tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
tabLayout.VerticalAlignment = Enum.VerticalAlignment.Center
tabLayout.Parent = tabScroll

local function createTab(text, index)
    local tab = Instance.new("TextButton")
    tab.Size = UDim2.new(0, 58, 1, -4)
    tab.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
    tab.Text = text
    tab.TextSize = 11
    tab.Font = Enum.Font.GothamBold
    tab.TextColor3 = Color3.fromRGB(100, 100, 100)
    tab.LayoutOrder = index
    tab.Parent = tabScroll
    Instance.new("UICorner", tab).CornerRadius = UDim.new(0, 4)
    return tab
end

local tab1 = createTab("åŸºæœ¬è¨­ç½®", 1)
local tab2 = createTab("é˜²åç¹", 2)
local tab3 = createTab("forsaken", 3)
local tab4 = createTab("die of death", 4)

-- è‡ªå‹•èª¿æ•´ CanvasSize
local function updateTabScrollCanvas()
    local totalWidth = 0
    for _, child in ipairs(tabScroll:GetChildren()) do
        if child:IsA("TextButton") then
            totalWidth = totalWidth + child.AbsoluteSize.X + 2
        end
    end
    tabScroll.CanvasSize = UDim2.new(0, totalWidth + 4, 0, 0)
end
task.defer(updateTabScrollCanvas)

local contentContainer = Instance.new("Frame")
contentContainer.Size = UDim2.new(0.9, 0, 0, 150) 
contentContainer.Position = UDim2.new(0.05, 0, 0, 72)
contentContainer.BackgroundTransparency = 1
contentContainer.Parent = mainFrame
contentContainer.ClipsDescendants = true 

local function createScrollingPage(parent)
    local page = Instance.new("ScrollingFrame")
    page.Size = UDim2.new(1, 0, 1, 0)
    page.BackgroundTransparency = 1
    page.BorderSizePixel = 0
    page.ScrollBarThickness = 4
    page.AutomaticCanvasSize = Enum.AutomaticSize.Y
    page.Visible = false
    page.Parent = parent
    local layout = Instance.new("UIListLayout")
    layout.Padding = UDim.new(0, 6)
    layout.SortOrder = Enum.SortOrder.LayoutOrder
    layout.HorizontalAlignment = Enum.HorizontalAlignment.Center
    layout.Parent = page
    local padding = Instance.new("UIPadding")
    padding.PaddingRight = UDim.new(0, 6)
    padding.Parent = page
    return page
end

local page1 = createScrollingPage(contentContainer)
local page2 = createScrollingPage(contentContainer)
local page3 = createScrollingPage(contentContainer)
local page4 = createScrollingPage(contentContainer)
page1.Visible = true

local function switchTab(pageNum)
    page1.Visible = (pageNum == 1)
    page2.Visible = (pageNum == 2)
    page3.Visible = (pageNum == 3)
    page4.Visible = (pageNum == 4)
    local tabs = {tab1, tab2, tab3, tab4}
    for i, tab in ipairs(tabs) do
        tab.BackgroundColor3 = (pageNum == i) and Color3.fromRGB(102, 126, 234) or Color3.fromRGB(200, 200, 200)
        tab.TextColor3 = (pageNum == i) and Color3.new(1,1,1) or Color3.fromRGB(100,100,100)
    end
end
tab1.MouseButton1Click:Connect(function() switchTab(1) end)
tab2.MouseButton1Click:Connect(function() switchTab(2) end)
tab3.MouseButton1Click:Connect(function() switchTab(3) end)
tab4.MouseButton1Click:Connect(function() switchTab(4) end)

-- é€šç”¨UIå‰µå»ºå‡½æ•¸
local function createControlRow(parent, labelText, placeholder, defaultVal, isInput, order)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 32)
    frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
    frame.LayoutOrder = order or 0
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 75, 1, 0)
    label.Position = UDim2.new(0, 6, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(85, 85, 85)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local input
    if isInput then
        input = Instance.new("TextBox")
        input.Size = UDim2.new(0, 65, 0, 22)
        input.Position = UDim2.new(0, 80, 0, 5)
        input.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
        input.BorderSizePixel = 1; input.BorderColor3 = Color3.fromRGB(221,221,221)
        input.Text = defaultVal
        input.PlaceholderText = placeholder
        input.TextSize = 13
        input.Font = Enum.Font.Gotham
        input.TextColor3 = Color3.fromRGB(50, 50, 50)
        input.Parent = frame
        Instance.new("UICorner", input).CornerRadius = UDim.new(0, 5)
    else
        input = Instance.new("TextLabel")
        input.Size = UDim2.new(0, 65, 0, 22)
        input.Position = UDim2.new(0, 80, 0, 5)
        input.BackgroundTransparency = 1
        input.Text = "é—œé–‰"
        input.TextSize = 13
        input.Font = Enum.Font.Gotham
        input.TextColor3 = Color3.fromRGB(150, 150, 150)
        input.Parent = frame
    end

    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0, 50, 0, 22)
    btn.Position = UDim2.new(1, -55, 0, 5)
    btn.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
    btn.Text = "å•Ÿå‹•"
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.fromRGB(255, 255, 255)
    btn.Parent = frame
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 5)

    return frame, input, btn
end

-- å‰µå»ºç„¡æŒ‰éˆ•çš„è¼¸å…¥è¡Œ
local function createInputOnlyRow(parent, labelText, defaultVal, order)
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(1, 0, 0, 32)
    frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
    frame.LayoutOrder = order or 0
    frame.Parent = parent
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 6)

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(0, 120, 1, 0)
    label.Position = UDim2.new(0, 6, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = labelText
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.fromRGB(85, 85, 85)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = frame

    local input = Instance.new("TextBox")
    input.Size = UDim2.new(0, 100, 0, 22)
    input.Position = UDim2.new(1, -105, 0, 5)
    input.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    input.BorderSizePixel = 1
    input.BorderColor3 = Color3.fromRGB(221, 221, 221)
    input.Text = defaultVal
    input.TextSize = 13
    input.Font = Enum.Font.Gotham
    input.TextColor3 = Color3.fromRGB(50, 50, 50)
    input.Parent = frame
    Instance.new("UICorner", input).CornerRadius = UDim.new(0, 5)

    return frame, input
end

-- é é¢ 1 - åŸºæœ¬è¨­ç½®
local speedFrame, speedInput, speedButton = createControlRow(page1, "é€Ÿåº¦:", "34", "34", true, 1)
local fullbrightFrame, fullbrightInput, fullbrightButton = createControlRow(page1, "å…¨äº®:", "1", "1", true, 2)
local cameraDistFrame, cameraDistInput, cameraDistButton = createControlRow(page1, "é¡é ­è·é›¢:", "80", "80", true, 3)
local nofogFrame, nofogStatus, nofogButton = createControlRow(page1, "é™¤éœ§:", "", "", false, 4)
local noFilterFrame, noFilterStatus, noFilterButton = createControlRow(page1, "ç„¡æ¿¾é¡:", "", "", false, 5)

-- é é¢ 2 - é˜²åç¹
local evadeFrame, evadeStatus, evadeButton = createControlRow(page2, "é˜²åç¹:", "", "", false, 1)
local evadeRangeFrame, evadeRangeInput = createInputOnlyRow(page2, "è¿½æ“Šç¯„åœ:", "15", 2)
local evadeSpeedFrame, evadeSpeedInput = createInputOnlyRow(page2, "è¿½æ“Šé€Ÿåº¦:", "30", 3)
local minDistanceFrame, minDistanceInput = createInputOnlyRow(page2, "æœ€å°è·é›¢:", "3", 4)

-- æ·»åŠ é˜²åç¹æ¨¡å¼é¸æ“‡
local counterModeFrame = Instance.new("Frame")
counterModeFrame.Size = UDim2.new(1, 0, 0, 35)
counterModeFrame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
counterModeFrame.BorderSizePixel = 0
counterModeFrame.LayoutOrder = 5
counterModeFrame.Parent = page2
Instance.new("UICorner", counterModeFrame).CornerRadius = UDim.new(0, 6)

local counterModeLabel = Instance.new("TextLabel")
counterModeLabel.Size = UDim2.new(0.35, 0, 1, 0)
counterModeLabel.Position = UDim2.new(0, 8, 0, 0)
counterModeLabel.BackgroundTransparency = 1
counterModeLabel.Text = "é˜²åç¹æ¨¡å¼:"
counterModeLabel.TextSize = 12
counterModeLabel.Font = Enum.Font.GothamMedium
counterModeLabel.TextColor3 = Color3.fromRGB(33, 33, 33)
counterModeLabel.TextXAlignment = Enum.TextXAlignment.Left
counterModeLabel.Parent = counterModeFrame

local counterModeButton = Instance.new("TextButton")
counterModeButton.Size = UDim2.new(0.3, 0, 0, 26)
counterModeButton.Position = UDim2.new(0.68, 0, 0.5, -13)
counterModeButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
counterModeButton.Text = "å½è£"
counterModeButton.TextSize = 11
counterModeButton.Font = Enum.Font.GothamBold
counterModeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
counterModeButton.Parent = counterModeFrame
Instance.new("UICorner", counterModeButton).CornerRadius = UDim.new(0, 5)

local counterModeStatus = Instance.new("TextLabel")
counterModeStatus.Size = UDim2.new(0.25, 0, 1, 0)
counterModeStatus.Position = UDim2.new(0.38, 0, 0, 0)
counterModeStatus.BackgroundTransparency = 1
counterModeStatus.Text = "å½è£"
counterModeStatus.TextSize = 11
counterModeStatus.Font = Enum.Font.GothamBold
counterModeStatus.TextColor3 = Color3.fromRGB(76, 175, 80)
counterModeStatus.Parent = counterModeFrame

-- é é¢ 3 - forsaken
local generatorESPFrame, generatorESPStatus, generatorESPButton = createControlRow(page3, "ç™¼é›»æ©Ÿé¡¯ç¤º:", "", "", false, 1)
local itemESPFrame, itemESPStatus, itemESPButton = createControlRow(page3, "ç‰©å“é¡¯ç¤º:", "", "", false, 2)
local autoInvisFrame, autoInvisStatus, autoInvisButton = createControlRow(page3, "éš±å½¢(forsakenç”¨):", "", "", false, 3)

local statusLabel = Instance.new("TextLabel")
statusLabel.Size = UDim2.new(0.9, 0, 0, 26)
statusLabel.Position = UDim2.new(0.05, 0, 1, -32)
statusLabel.BackgroundColor3 = Color3.fromRGB(255, 235, 238)
statusLabel.Text = "ç³»çµ±å°±ç·’"
statusLabel.TextSize = 11
statusLabel.Font = Enum.Font.GothamBold
statusLabel.TextColor3 = Color3.fromRGB(198, 40, 40)
statusLabel.Parent = mainFrame
Instance.new("UICorner", statusLabel).CornerRadius = UDim.new(0, 5)

-- ====================
-- åŠŸèƒ½å¯¦ä½œ
-- ====================

local function updateStatus()
    local active = {}
    if toggles.speed then table.insert(active, "é€Ÿåº¦") end
    if toggles.fullbright then table.insert(active, "å…¨äº®") end
    if toggles.counterEvade then table.insert(active, "é˜²åç¹") end
    
    if #active > 0 then
        statusLabel.Text = "âœ… " .. table.concat(active, " | ")
        statusLabel.BackgroundColor3 = Color3.fromRGB(232, 245, 233)
        statusLabel.TextColor3 = Color3.fromRGB(46, 125, 50)
    else
        statusLabel.Text = "ç³»çµ±å°±ç·’"
        statusLabel.BackgroundColor3 = Color3.fromRGB(255, 235, 238)
        statusLabel.TextColor3 = Color3.fromRGB(198, 40, 40)
    end
end

local function toggleUIState(btn, frame, input, isActive)
    if isActive then
        btn.Text = "è§£é™¤"; btn.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
        frame.BackgroundColor3 = Color3.fromRGB(227, 242, 253)
        if input and input:IsA("TextBox") then input.TextEditable = false end
    else
        btn.Text = "å•Ÿå‹•"; btn.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
        frame.BackgroundColor3 = Color3.fromRGB(248, 249, 250)
        if input and input:IsA("TextBox") then input.TextEditable = true end
    end
    updateStatus()
end

-- é€Ÿåº¦
speedButton.MouseButton1Click:Connect(function()
    toggles.speed = not toggles.speed
    if toggles.speed then
        if not hasOriginalValues then getOriginalValues() end
        values.speed = tonumber(speedInput.Text) or 34
        applySpeed()
    else
        applySpeed()
    end
    toggleUIState(speedButton, speedFrame, speedInput, toggles.speed)
end)

-- å…¨äº®
fullbrightButton.MouseButton1Click:Connect(function()
    toggles.fullbright = not toggles.fullbright
    if toggles.fullbright then
        local val = tonumber(fullbrightInput.Text) or 1
        values.fullbright = math.clamp(val, 0, 99)
        if val ~= values.fullbright then fullbrightInput.Text = tostring(values.fullbright) end
    end
    updateLighting()
    toggleUIState(fullbrightButton, fullbrightFrame, fullbrightInput, toggles.fullbright)
end)

-- ç„¡æ¿¾é¡
noFilterButton.MouseButton1Click:Connect(function()
    toggles.noFilter = not toggles.noFilter
    if toggles.noFilter then
        noFilterStatus.Text = "é–‹å•Ÿ"
        noFilterStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        if connections.noFilter then connections.noFilter:Disconnect() end
        connections.noFilter = RunService.RenderStepped:Connect(function()
            for _, v in pairs(Lighting:GetChildren()) do
                if v:IsA("BloomEffect") then
                    v.Enabled = false
                    v.Intensity = 0
                    v.Size = 0
                    v.Threshold = 0
                elseif v:IsA("BlurEffect") then
                    v.Enabled = false
                    v.Size = 0
                elseif v:IsA("ColorCorrectionEffect") then
                    v.Enabled = false
                    v.Brightness = 0
                    v.Contrast = 0
                    v.Saturation = 0
                    v.TintColor = Color3.new(1, 1, 1)
                elseif v:IsA("DepthOfFieldEffect") then
                    v.Enabled = false
                    v.FarIntensity = 0
                    v.NearIntensity = 0
                elseif v:IsA("SunRaysEffect") then
                    v.Enabled = false
                    v.Intensity = 0
                elseif v:IsA("PostEffect") then
                    v.Enabled = false
                end
            end
            if Workspace.CurrentCamera then
                 for _, v in pairs(Workspace.CurrentCamera:GetChildren()) do
                    if v:IsA("BloomEffect") then
                        v.Enabled = false
                        v.Intensity = 0
                        v.Size = 0
                        v.Threshold = 0
                    elseif v:IsA("BlurEffect") then
                        v.Enabled = false
                        v.Size = 0
                    elseif v:IsA("ColorCorrectionEffect") then
                        v.Enabled = false
                        v.Brightness = 0
                        v.Contrast = 0
                        v.Saturation = 0
                        v.TintColor = Color3.new(1, 1, 1)
                    elseif v:IsA("DepthOfFieldEffect") then
                        v.Enabled = false
                        v.FarIntensity = 0
                        v.NearIntensity = 0
                    elseif v:IsA("SunRaysEffect") then
                        v.Enabled = false
                        v.Intensity = 0
                    elseif v:IsA("PostEffect") then
                        v.Enabled = false
                    end
                end
            end
        end)
    else
        noFilterStatus.Text = "é—œé–‰"
        noFilterStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        if connections.noFilter then connections.noFilter:Disconnect() end
    end
    toggleUIState(noFilterButton, noFilterFrame, noFilterStatus, toggles.noFilter)
end)

-- é™¤éœ§
nofogButton.MouseButton1Click:Connect(function()
    toggles.nofog = not toggles.nofog
    if toggles.nofog then
        nofogStatus.Text = "é–‹å•Ÿ"; nofogStatus.TextColor3 = Color3.fromRGB(46,125,50)
        if connections.nofog then connections.nofog:Disconnect() end
        connections.nofog = RunService.RenderStepped:Connect(function()
            Lighting.FogEnd = 100000
            for _, v in pairs(Lighting:GetDescendants()) do
                if v:IsA("Atmosphere") then 
                    v.Density = 0
                    v.Offset = 0
                    v.Color = Color3.new(1, 1, 1)
                    v.Decay = Color3.new(1, 1, 1)
                    v.Glare = 0
                    v.Haze = 0
                end
            end
        end)
    else
        nofogStatus.Text = "é—œé–‰"; nofogStatus.TextColor3 = Color3.fromRGB(150,150,150)
        if connections.nofog then connections.nofog:Disconnect() end
        Lighting.FogEnd = trueLightingBackup.FogEnd or 1000
    end
    toggleUIState(nofogButton, nofogFrame, nofogStatus, toggles.nofog)
end)

-- é¡é ­è·é›¢
cameraDistButton.MouseButton1Click:Connect(function()
    toggles.cameraDist = not toggles.cameraDist
    if toggles.cameraDist then
        values.cameraDist = tonumber(cameraDistInput.Text) or 80
        player.CameraMaxZoomDistance = values.cameraDist
        player.CameraMinZoomDistance = values.cameraDist
        if player.Character then
            local hum = player.Character:FindFirstChildOfClass("Humanoid")
            if hum then hum.CameraOffset = Vector3.new(0,0,0) end
        end
        task.delay(0.1, function()
            if toggles.cameraDist then player.CameraMinZoomDistance = 0.5 end
        end)
    else
        player.CameraMaxZoomDistance = 128
        player.CameraMinZoomDistance = 0.5
    end
    toggleUIState(cameraDistButton, cameraDistFrame, cameraDistInput, toggles.cameraDist)
end)

-- é˜²åç¹
evadeButton.MouseButton1Click:Connect(function()
    toggles.counterEvade = not toggles.counterEvade
    if toggles.counterEvade then
        values.evadeRange = tonumber(evadeRangeInput.Text) or 15
        values.evadeSpeed = tonumber(evadeSpeedInput.Text) or 30
        values.minDistance = tonumber(minDistanceInput.Text) or 3
        
        startCounterEvade()
        evadeStatus.Text = "é–‹å•Ÿ"
        evadeStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    else
        if connections.counterEvade then connections.counterEvade:Disconnect() end
        evadeStatus.Text = "é—œé–‰"
        evadeStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        -- ã€æ–°å¢ã€‘é—œé–‰é˜²åç¹æ™‚æ¸…é™¤æ‰‹å‹•é–å®š
        manualLockedTarget = nil
        lockedTarget = nil
    end
    toggleUIState(evadeButton, evadeFrame, evadeStatus, toggles.counterEvade)
end)

-- é˜²åç¹æ¨¡å¼åˆ‡æ›æŒ‰éˆ•
counterModeButton.MouseButton1Click:Connect(function()
    if toggles.counterEvadeMode == "disguise" then
        toggles.counterEvadeMode = "fullpower"
        counterModeButton.Text = "å…¨é–‹"
        counterModeButton.BackgroundColor3 = Color3.fromRGB(244, 67, 54)
        counterModeStatus.Text = "å…¨é–‹"
        counterModeStatus.TextColor3 = Color3.fromRGB(244, 67, 54)
    else
        toggles.counterEvadeMode = "disguise"
        counterModeButton.Text = "å½è£"
        counterModeButton.BackgroundColor3 = Color3.fromRGB(76, 175, 80)
        counterModeStatus.Text = "å½è£"
        counterModeStatus.TextColor3 = Color3.fromRGB(76, 175, 80)
    end
end)

-- æ›´æ–°é˜²åç¹åƒæ•¸
evadeRangeInput.FocusLost:Connect(function()
    values.evadeRange = tonumber(evadeRangeInput.Text) or 15
    evadeRangeInput.Text = tostring(values.evadeRange)
end)

evadeSpeedInput.FocusLost:Connect(function()
    values.evadeSpeed = tonumber(evadeSpeedInput.Text) or 30
    evadeSpeedInput.Text = tostring(values.evadeSpeed)
end)

minDistanceInput.FocusLost:Connect(function()
    values.minDistance = tonumber(minDistanceInput.Text) or 3
    minDistanceInput.Text = tostring(values.minDistance)
end)

-- ç™¼é›»æ©Ÿé¡¯ç¤º
generatorESPButton.MouseButton1Click:Connect(function()
    toggles.generatorESP = not toggles.generatorESP
    if toggles.generatorESP then
        generatorESPStatus.Text = "é–‹å•Ÿ"
        generatorESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        updateGeneratorESP()
        startGeneratorMonitoring()
    else
        generatorESPStatus.Text = "é—œé–‰"
        generatorESPStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        clearESP("generators")
        if connections.generatorESP then connections.generatorESP:Disconnect() end
    end
    toggleUIState(generatorESPButton, generatorESPFrame, generatorESPStatus, toggles.generatorESP)
end)

-- ç‰©å“é¡¯ç¤º
itemESPButton.MouseButton1Click:Connect(function()
    toggles.itemESP = not toggles.itemESP
    if toggles.itemESP then
        itemESPStatus.Text = "é–‹å•Ÿ"
        itemESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
        updateItemESP()
        startItemMonitoring()
    else
        itemESPStatus.Text = "é—œé–‰"
        itemESPStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
        clearESP("items")
        if connections.itemESP then connections.itemESP:Disconnect() end
    end
    toggleUIState(itemESPButton, itemESPFrame, itemESPStatus, toggles.itemESP)
end)

-- éš±å½¢æŒ‰éˆ•
autoInvisButton.MouseButton1Click:Connect(function()
    toggles.autoInvisible = not toggles.autoInvisible
    autoInvisToggles.autoEvade = toggles.autoInvisible
    
    if toggles.autoInvisible then
        startAutoInvisible()
        autoInvisStatus.Text = "é–‹å•Ÿ"
        autoInvisStatus.TextColor3 = Color3.fromRGB(138, 43, 226)
    else
        if autoInvisConnections.autoEvade then autoInvisConnections.autoEvade:Disconnect() end
        autoInvisStatus.Text = "é—œé–‰"
        autoInvisStatus.TextColor3 = Color3.fromRGB(150, 150, 150)
    end
    toggleUIState(autoInvisButton, autoInvisFrame, autoInvisStatus, toggles.autoInvisible)
end)

-- ====================
-- é é¢ 4 - die of death
-- ====================

-- è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹åˆ†å€æ¨™é¡Œ
local function createSectionHeader(parent, text, order)
    local header = Instance.new("Frame")
    header.Size = UDim2.new(1, 0, 0, 24)
    header.BackgroundColor3 = Color3.fromRGB(102, 126, 234)
    header.BorderSizePixel = 0
    header.LayoutOrder = order
    header.Parent = parent
    Instance.new("UICorner", header).CornerRadius = UDim.new(0, 6)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -8, 1, 0)
    label.Position = UDim2.new(0, 8, 0, 0)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextSize = 12
    label.Font = Enum.Font.GothamBold
    label.TextColor3 = Color3.new(1, 1, 1)
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = header
    return header
end

-- è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹é¸æ“‡æŒ‰éˆ•çµ„
local function createChoiceButton(parent, text, color, order)
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(0.3, -4, 0, 28)
    btn.BackgroundColor3 = color or Color3.fromRGB(80, 80, 90)
    btn.Text = text
    btn.TextSize = 11
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.LayoutOrder = order
    btn.Parent = parent
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    local stroke = Instance.new("UIStroke")
    stroke.Thickness = 1
    stroke.Color = Color3.fromRGB(120, 120, 130)
    stroke.Parent = btn
    return btn, stroke
end

-- â–Œéƒ¨åˆ†ä¸€ï¼šé¸è§’è‰²
createSectionHeader(page4, "â–Œ é¸è§’è‰²", 10)

local charBtnFrame = Instance.new("Frame")
charBtnFrame.Size = UDim2.new(1, 0, 0, 36)
charBtnFrame.BackgroundTransparency = 1
charBtnFrame.LayoutOrder = 11
charBtnFrame.Parent = page4
local charBtnLayout = Instance.new("UIListLayout")
charBtnLayout.FillDirection = Enum.FillDirection.Horizontal
charBtnLayout.Padding = UDim.new(0, 4)
charBtnLayout.HorizontalAlignment = Enum.HorizontalAlignment.Center
charBtnLayout.VerticalAlignment = Enum.VerticalAlignment.Center
charBtnLayout.Parent = charBtnFrame

local btnNormal, strokeNormal = createChoiceButton(charBtnFrame, "æ™®é€š", Color3.fromRGB(70, 130, 180), 1)
local btnCaretaker, strokeCaretaker = createChoiceButton(charBtnFrame, "æ²»ç™‚å¢Š", Color3.fromRGB(60, 160, 100), 2)
local btnRevolver, strokeRevolver = createChoiceButton(charBtnFrame, "æ„›æ§", Color3.fromRGB(180, 80, 80), 3)

-- è§’è‰²é¸æ“‡çµæœæç¤º
local charResultLabel = Instance.new("TextLabel")
charResultLabel.Size = UDim2.new(1, 0, 0, 20)
charResultLabel.BackgroundTransparency = 1
charResultLabel.Text = "å°šæœªé¸æ“‡è§’è‰²"
charResultLabel.TextSize = 11
charResultLabel.Font = Enum.Font.Gotham
charResultLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
charResultLabel.LayoutOrder = 12
charResultLabel.Parent = page4

local function setCharBtnSelected(selectedStroke)
    for _, s in ipairs({strokeNormal, strokeCaretaker, strokeRevolver}) do
        s.Color = Color3.fromRGB(120, 120, 130)
        s.Thickness = 1
    end
    selectedStroke.Color = Color3.fromRGB(255, 220, 0)
    selectedStroke.Thickness = 2
end

btnNormal.MouseButton1Click:Connect(function()
    setCharBtnSelected(strokeNormal)
    charResultLabel.Text = "âœ“ å·²é¸ï¼šæ™®é€š (Cloak)"
    charResultLabel.TextColor3 = Color3.fromRGB(70, 130, 180)
    pcall(function()
        local args = {{"Cloak"}}
        game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("RemoteEvents"):WaitForChild("AbilitySelection"):FireServer(unpack(args))
    end)
end)

btnCaretaker.MouseButton1Click:Connect(function()
    setCharBtnSelected(strokeCaretaker)
    charResultLabel.Text = "âœ“ å·²é¸ï¼šæ²»ç™‚å¢Š (BonusPad)"
    charResultLabel.TextColor3 = Color3.fromRGB(60, 160, 100)
    pcall(function()
        local args = {{"Caretaker", "BonusPad"}}
        game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("RemoteEvents"):WaitForChild("AbilitySelection"):FireServer(unpack(args))
    end)
end)

btnRevolver.MouseButton1Click:Connect(function()
    setCharBtnSelected(strokeRevolver)
    charResultLabel.Text = "âœ“ å·²é¸ï¼šæ„›æ§ (Revolver)"
    charResultLabel.TextColor3 = Color3.fromRGB(180, 80, 80)
    pcall(function()
        local args = {{"Caretaker", "Revolver"}}
        game:GetService("ReplicatedStorage"):WaitForChild("Events"):WaitForChild("RemoteEvents"):WaitForChild("AbilitySelection"):FireServer(unpack(args))
    end)
end)

-- â–Œéƒ¨åˆ†äºŒï¼šè‡ªç”¨èƒ½åŠ›
createSectionHeader(page4, "â–Œ è‡ªç”¨èƒ½åŠ›", 20)

-- èƒ½åŠ›å®šç¾© {é¡¯ç¤ºå, äº‹ä»¶å, å†·å»ç§’æ•¸}
local abilities = {
    {"é˜²ç¦¦",    "Block",        40},
    {"éš±å½¢",    "Cloak",        40},
    {"æ‰‹æ§",    "Revolver",     15},
    {"æäºº",    "Punch",        40},
    {"å›è¡€è—¥æ°´","Caretaker",    30},
    {"åŠ é€Ÿæ¿",  "BonusPad",     60},
    {"ç†±ç‹—",    "Hotdog",       25},
    {"å˜²è«·",    "Taunt",        25},
    {"è…ä¸Šè…ºç´ ","Adrenaline",   35},
    {"é¦™è•‰çš®",  "Banana",       20},
    {"è¡åˆº",    "Dash",         20},
}

-- é¡è‰²åˆ—è¡¨ï¼ˆå¾ªç’°ä½¿ç”¨ï¼‰
local abilityColors = {
    Color3.fromRGB(100, 100, 200),
    Color3.fromRGB(100, 60, 160),
    Color3.fromRGB(180, 100, 40),
    Color3.fromRGB(180, 70, 70),
    Color3.fromRGB(60, 160, 100),
    Color3.fromRGB(70, 130, 180),
    Color3.fromRGB(180, 130, 40),
    Color3.fromRGB(160, 80, 140),
    Color3.fromRGB(80, 160, 160),
    Color3.fromRGB(140, 160, 60),
    Color3.fromRGB(100, 150, 200),
}

-- å†·å»ç‹€æ…‹
local abilityCooldowns = {}
for i = 1, #abilities do
    abilityCooldowns[i] = 0
end

-- æ¯å€‹èƒ½åŠ›ä¸€å€‹æŒ‰éˆ•è¡Œ
for i, ability in ipairs(abilities) do
    local abilityName, eventName, cooldown = ability[1], ability[2], ability[3]
    local color = abilityColors[((i-1) % #abilityColors) + 1]
    
    local row = Instance.new("Frame")
    row.Size = UDim2.new(1, 0, 0, 30)
    row.BackgroundColor3 = Color3.fromRGB(245, 245, 248)
    row.BorderSizePixel = 0
    row.LayoutOrder = 20 + i
    row.Parent = page4
    Instance.new("UICorner", row).CornerRadius = UDim.new(0, 6)
    
    local btn = Instance.new("TextButton")
    btn.Size = UDim2.new(1, 0, 1, 0)
    btn.BackgroundColor3 = color
    btn.Text = string.format("%sï¼ˆ%dsï¼‰", abilityName, cooldown)
    btn.TextSize = 12
    btn.Font = Enum.Font.GothamBold
    btn.TextColor3 = Color3.new(1, 1, 1)
    btn.AutoButtonColor = false
    btn.Parent = row
    Instance.new("UICorner", btn).CornerRadius = UDim.new(0, 6)
    
    -- å†·å»è¦†è“‹å±¤
    local cooldownOverlay = Instance.new("Frame")
    cooldownOverlay.Size = UDim2.new(0, 0, 1, 0)
    cooldownOverlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    cooldownOverlay.BackgroundTransparency = 0.4
    cooldownOverlay.BorderSizePixel = 0
    cooldownOverlay.ZIndex = 2
    cooldownOverlay.Visible = false
    cooldownOverlay.Parent = btn
    Instance.new("UICorner", cooldownOverlay).CornerRadius = UDim.new(0, 6)
    
    -- é–‰åŒ…ä¿å­˜è®Šæ•¸
    local btnRef = btn
    local overlayRef = cooldownOverlay
    local abilityIndex = i
    local originalColor = color
    
    btn.MouseButton1Click:Connect(function()
        -- ç„¡è«–å†·å»èˆ‡å¦éƒ½è§¸ç™¼ï¼ˆä»¥é˜²å†·å»æ™‚é–“éŒ¯èª¤ï¼‰
        pcall(function()
            local args = {eventName}
            game:GetService("ReplicatedStorage")
                :WaitForChild("Events")
                :WaitForChild("RemoteFunctions")
                :WaitForChild("UseAbility")
                :InvokeServer(unpack(args))
        end)
        
        -- å•Ÿå‹•å†·å»å€’æ•¸ï¼ˆè¦–è¦ºé¡¯ç¤ºï¼‰
        local now = tick()
        abilityCooldowns[abilityIndex] = now + cooldown
        overlayRef.Visible = true
        
        task.spawn(function()
            local endTime = abilityCooldowns[abilityIndex]
            while tick() < endTime do
                local remaining = math.ceil(endTime - tick())
                local progress = (endTime - tick()) / cooldown
                progress = math.clamp(progress, 0, 1)
                
                -- æ›´æ–°æŒ‰éˆ•æ–‡å­—é¡¯ç¤ºå†·å»
                btnRef.Text = string.format("%sï¼ˆ%dsï¼‰", abilityName, remaining)
                
                -- æ›´æ–°è¦†è“‹å±¤å¯¬åº¦ï¼ˆå¾å³åˆ°å·¦æ¶ˆé€€ï¼‰
                overlayRef.Size = UDim2.new(progress, 0, 1, 0)
                overlayRef.Position = UDim2.new(0, 0, 0, 0)
                
                task.wait(0.1)
            end
            
            -- å†·å»çµæŸ
            overlayRef.Visible = false
            overlayRef.Size = UDim2.new(0, 0, 1, 0)
            btnRef.Text = string.format("%sï¼ˆ%dsï¼‰", abilityName, cooldown)
        end)
    end)
end

-- è‡ªå‹•å•Ÿç”¨åŠŸèƒ½
task.spawn(function()
    task.wait(1)
    
    -- è‡ªå‹•å•Ÿç”¨å…¨äº®
    toggles.fullbright = true
    updateLighting()
    toggleUIState(fullbrightButton, fullbrightFrame, fullbrightInput, true)
    
    -- è‡ªå‹•å•Ÿç”¨é¡é ­è·é›¢
    toggles.cameraDist = true
    player.CameraMaxZoomDistance = values.cameraDist
    player.CameraMinZoomDistance = values.cameraDist
    task.delay(0.1, function()
        if toggles.cameraDist then player.CameraMinZoomDistance = 0.5 end
    end)
    toggleUIState(cameraDistButton, cameraDistFrame, cameraDistInput, true)
    
    -- è‡ªå‹•å•Ÿç”¨é™¤éœ§
    toggles.nofog = true
    if connections.nofog then connections.nofog:Disconnect() end
    connections.nofog = RunService.RenderStepped:Connect(function()
        Lighting.FogEnd = 100000
        for _, v in pairs(Lighting:GetDescendants()) do
            if v:IsA("Atmosphere") then 
                v.Density = 0
                v.Offset = 0
                v.Color = Color3.new(1, 1, 1)
                v.Decay = Color3.new(1, 1, 1)
                v.Glare = 0
                v.Haze = 0
            end
        end
    end)
    nofogStatus.Text = "é–‹å•Ÿ"
    nofogStatus.TextColor3 = Color3.fromRGB(46,125,50)
    toggleUIState(nofogButton, nofogFrame, nofogStatus, true)
    
    -- è‡ªå‹•å•Ÿç”¨ç„¡æ¿¾é¡
    toggles.noFilter = true
    if connections.noFilter then connections.noFilter:Disconnect() end
    connections.noFilter = RunService.RenderStepped:Connect(function()
        for _, v in pairs(Lighting:GetChildren()) do
            if v:IsA("BloomEffect") then
                v.Enabled = false
                v.Intensity = 0
                v.Size = 0
                v.Threshold = 0
            elseif v:IsA("BlurEffect") then
                v.Enabled = false
                v.Size = 0
            elseif v:IsA("ColorCorrectionEffect") then
                v.Enabled = false
                v.Brightness = 0
                v.Contrast = 0
                v.Saturation = 0
                v.TintColor = Color3.new(1, 1, 1)
            elseif v:IsA("DepthOfFieldEffect") then
                v.Enabled = false
                v.FarIntensity = 0
                v.NearIntensity = 0
            elseif v:IsA("SunRaysEffect") then
                v.Enabled = false
                v.Intensity = 0
            elseif v:IsA("PostEffect") then
                v.Enabled = false
            end
        end
        if Workspace.CurrentCamera then
             for _, v in pairs(Workspace.CurrentCamera:GetChildren()) do
                if v:IsA("BloomEffect") then
                    v.Enabled = false
                    v.Intensity = 0
                    v.Size = 0
                    v.Threshold = 0
                elseif v:IsA("BlurEffect") then
                    v.Enabled = false
                    v.Size = 0
                elseif v:IsA("ColorCorrectionEffect") then
                    v.Enabled = false
                    v.Brightness = 0
                    v.Contrast = 0
                    v.Saturation = 0
                    v.TintColor = Color3.new(1, 1, 1)
                elseif v:IsA("DepthOfFieldEffect") then
                    v.Enabled = false
                    v.FarIntensity = 0
                    v.NearIntensity = 0
                elseif v:IsA("SunRaysEffect") then
                    v.Enabled = false
                    v.Intensity = 0
                elseif v:IsA("PostEffect") then
                    v.Enabled = false
                end
            end
        end
    end)
    noFilterStatus.Text = "é–‹å•Ÿ"
    noFilterStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    toggleUIState(noFilterButton, noFilterFrame, noFilterStatus, true)

    -- è‡ªå‹•å•Ÿç”¨ç™¼é›»æ©Ÿé¡¯ç¤º
    toggles.generatorESP = true
    generatorESPStatus.Text = "é–‹å•Ÿ"
    generatorESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    updateGeneratorESP()
    startGeneratorMonitoring()
    toggleUIState(generatorESPButton, generatorESPFrame, generatorESPStatus, true)
    
    -- è‡ªå‹•å•Ÿç”¨ç‰©å“é¡¯ç¤º
    toggles.itemESP = true
    itemESPStatus.Text = "é–‹å•Ÿ"
    itemESPStatus.TextColor3 = Color3.fromRGB(46, 125, 50)
    updateItemESP()
    startItemMonitoring()
    toggleUIState(itemESPButton, itemESPFrame, itemESPStatus, true)
end)

-- æ‹–æ›³åŠŸèƒ½
local function enableDrag(frame, dragHandle)
    local dragging = false
    local dragInput, dragStart, startPos

    local function update(input)
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = frame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
end

enableDrag(mainFrame, titleBar)

-- æœ€å°åŒ–UI
local miniFrame = Instance.new("Frame"); miniFrame.Size=UDim2.new(0,130,0,32); miniFrame.Position=UDim2.new(0.5,-65,0,30); miniFrame.BackgroundColor3=Color3.fromRGB(102,126,234); miniFrame.Visible=false; miniFrame.Parent=screenGui; Instance.new("UICorner", miniFrame).CornerRadius=UDim.new(0,6)
local miniTitle = Instance.new("TextLabel"); miniTitle.Text="ğŸ® æ§åˆ¶å™¨"; miniTitle.Size=UDim2.new(1,-36,1,0); miniTitle.BackgroundTransparency=1; miniTitle.Font=Enum.Font.GothamBold; miniTitle.TextSize=16; miniTitle.TextColor3=Color3.fromRGB(255,255,255); miniTitle.Parent=miniFrame
local expandButton = Instance.new("TextButton"); expandButton.Text="+"; expandButton.Size=UDim2.new(0,24,0,24); expandButton.Position=UDim2.new(1,-28,0,4); expandButton.BackgroundColor3=Color3.fromRGB(76,175,80); expandButton.TextColor3=Color3.fromRGB(255,255,255); expandButton.Parent=miniFrame; Instance.new("UICorner", expandButton).CornerRadius=UDim.new(0,5)
enableDrag(miniFrame, miniFrame)

minimizeButton.MouseButton1Click:Connect(function() mainFrame.Visible=false; miniFrame.Visible=true end)
expandButton.MouseButton1Click:Connect(function() miniFrame.Visible=false; mainFrame.Visible=true end)

-- é—œé–‰æŒ‰éˆ•
closeButton.MouseButton1Click:Connect(function()
    screenGui:Destroy()
    for _, v in pairs(connections) do if v then v:Disconnect() end end
    
    clearESP("generators")
    clearESP("items")
    
    Lighting.Ambient = trueLightingBackup.Ambient
    Lighting.Brightness = trueLightingBackup.Brightness
    Lighting.OutdoorAmbient = trueLightingBackup.OutdoorAmbient
    Lighting.ColorShift_Top = trueLightingBackup.ColorShift_Top
    Lighting.ColorShift_Bottom = trueLightingBackup.ColorShift_Bottom
    local char = player.Character
    if char then
        local hum = char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.WalkSpeed = originalSpeed
        end
    end
end)

-- åˆå§‹åŒ–
task.spawn(function()
    if player.Character then task.wait(0.1); getOriginalValues() end
end)

print(update)
print(update2)

-- ====================
-- ShiftLock + ESP UI æ•´åˆï¼ˆæ–°ç‰ˆï¼‰
-- ====================
task.spawn(function()
    pcall(function()
        local ref = cloneref or function(x) return x end
        local S = function(n) return ref(game:GetService(n)) end

        local Plrs, Tw, UIS, RS, Wk, CG =
            S("Players"), S("TweenService"), S("UserInputService"), S("RunService"), S("Workspace"), S("CoreGui")

        local plr = Plrs.LocalPlayer

        local function parentShiftUI(g)
            if gethui then
                g.Name = "\0" .. g.Name
                g.Parent = gethui()
                return g
            elseif CG then
                g.Parent = CG
                return g
            else
                g.Parent = plr:WaitForChild("PlayerGui")
                return g
            end
        end

        shiftLockUI = Instance.new("ScreenGui")
        shiftLockUI.Name = "ShiftLockUI"
        shiftLockUI.ResetOnSpawn = false
        shiftLockUI.IgnoreGuiInset = true
        parentShiftUI(shiftLockUI)

        -- æŒ‰éˆ•è®Šæ•¸
        local btn, nearBtn, clickBtn, espBtn, strk, icn

        local function updateButtonState(button, active)
            local activeColor = Color3.fromRGB(50, 100, 150)
            local inactiveColor = Color3.fromRGB(40, 40, 45)
            
            Tw:Create(button, TweenInfo.new(0.2), {
                BackgroundColor3 = active and activeColor or inactiveColor
            }):Play()
            
            local stroke = button:FindFirstChild("BtnStroke")
            if stroke then
                Tw:Create(stroke, TweenInfo.new(0.2), {
                    Color = active and Color3.fromRGB(0, 200, 255) or Color3.fromRGB(80, 80, 90),
                    Thickness = active and 2 or 1
                }):Play()
            end
        end

        local function clearAllModesUI()
            if lockRotCon then lockRotCon:Disconnect(); lockRotCon = nil end
            if lockMouseClickConn then lockMouseClickConn:Disconnect(); lockMouseClickConn = nil end
            
            if UIS.MouseEnabled then
                UIS.MouseBehavior = Enum.MouseBehavior.Default
            end
            
            local char = plr.Character
            if char then
                local h = char:FindFirstChildOfClass("Humanoid")
                if h then h.AutoRotate = true end
            end
            
            icn.Image = "rbxasset://textures/ui/mouseLock_off.png"
            Tw:Create(strk, TweenInfo.new(0.2), {Color = Color3.fromRGB(0, 140, 255), Thickness = 2}):Play()
            Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(34, 34, 38)}):Play()
            updateButtonState(nearBtn, false)
            updateButtonState(clickBtn, false)
            lockMode = "none"
            shiftLockEnabled = false
            lockTargetPlayer = nil
            lastClickedPlayer = nil
        end

        -- UI å‰µå»º
        btn = Instance.new("ImageButton")
        btn.Name = "LockBtn"; btn.AnchorPoint = Vector2.new(0.5, 0.5); btn.Size = UDim2.fromOffset(64, 64)
        btn.Position = UDim2.new(1, -30, 1, -30); btn.BackgroundColor3 = Color3.fromRGB(34, 34, 38)
        btn.AutoButtonColor = false; btn.Parent = shiftLockUI
        local cr = Instance.new("UICorner"); cr.CornerRadius = UDim.new(1, 0); cr.Parent = btn
        strk = Instance.new("UIStroke"); strk.Thickness = 2; strk.Color = Color3.fromRGB(0, 140, 255); strk.Parent = btn
        icn = Instance.new("ImageLabel")
        icn.Name = "Icn"; icn.BackgroundTransparency = 1; icn.AnchorPoint = Vector2.new(0.5, 0.5)
        icn.Position = UDim2.fromScale(0.5, 0.5); icn.Size = UDim2.fromScale(0.62, 0.62)
        icn.Image = "rbxasset://textures/ui/mouseLock_off.png"; icn.Parent = btn

        -- å°ˆç”¨æ‹–æ›³æŠŠæ‰‹
        local dragHandle = Instance.new("Frame")
        dragHandle.Name = "DragHandle"
        dragHandle.AnchorPoint = Vector2.new(0.5, 1)
        dragHandle.Position = UDim2.new(0.5, 0, 0, -2)
        dragHandle.Size = UDim2.fromOffset(40, 6)
        dragHandle.BackgroundColor3 = Color3.fromRGB(100, 100, 110)
        dragHandle.BorderSizePixel = 0
        dragHandle.Parent = btn
        
        local handleCorner = Instance.new("UICorner")
        handleCorner.CornerRadius = UDim.new(1, 0)
        handleCorner.Parent = dragHandle
        
        -- æ‹–æ›³æŠŠæ‰‹çš„è¦–è¦ºæç¤ºï¼ˆ3å€‹å°é»ï¼‰
        local dot1 = Instance.new("Frame")
        dot1.Size = UDim2.fromOffset(2, 2)
        dot1.Position = UDim2.new(0.3, 0, 0.5, -1)
        dot1.BackgroundColor3 = Color3.fromRGB(200, 200, 200)
        dot1.BorderSizePixel = 0
        dot1.Parent = dragHandle
        Instance.new("UICorner", dot1).CornerRadius = UDim.new(1, 0)
        
        local dot2 = dot1:Clone()
        dot2.Position = UDim2.new(0.5, 0, 0.5, -1)
        dot2.Parent = dragHandle
        
        local dot3 = dot1:Clone()
        dot3.Position = UDim2.new(0.7, 0, 0.5, -1)
        dot3.Parent = dragHandle

        local xBtn = Instance.new("TextButton")
        xBtn.Name = "Close"; xBtn.AnchorPoint = Vector2.new(1, 0); xBtn.Position = UDim2.new(1, 5, 0, -5)
        xBtn.Size = UDim2.fromOffset(18, 18); xBtn.BackgroundColor3 = Color3.fromRGB(230, 60, 60); xBtn.Text = "Ã—"
        xBtn.TextSize = 14; xBtn.TextColor3 = Color3.new(1, 1, 1); xBtn.Parent = btn
        Instance.new("UICorner").Parent = xBtn

        local extBtn = Instance.new("TextButton")
        extBtn.Name = "ExtendBtn"; extBtn.AnchorPoint = Vector2.new(0.5, 1); extBtn.Position = UDim2.new(0.5, 0, 0, -15)
        extBtn.Size = UDim2.fromOffset(56, 22); extBtn.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
        extBtn.Text = "å»¶ä¼¸"; extBtn.TextSize = 12
        extBtn.TextColor3 = Color3.new(1, 1, 1)
        extBtn.Parent = btn
        Instance.new("UICorner").Parent = extBtn

        local extFrame = Instance.new("Frame")
        extFrame.Name = "ExtFrame"; extFrame.AnchorPoint = Vector2.new(0.5, 1); extFrame.Position = UDim2.new(0.5, 0, 0, -42)
        extFrame.Size = UDim2.fromOffset(64, 0); extFrame.BackgroundTransparency = 1; extFrame.ClipsDescendants = true; extFrame.Parent = btn

        local function createExtraBtn(name, yPos)
            local b = Instance.new("TextButton")
            b.Name = name; b.Size = UDim2.fromOffset(60, 26); b.Position = UDim2.fromOffset(2, yPos)
            b.BackgroundColor3 = Color3.fromRGB(40, 40, 45); b.Text = name; b.TextSize = 11; b.TextColor3 = Color3.new(1,1,1); b.Parent = extFrame
            local c = Instance.new("UICorner"); c.CornerRadius = UDim.new(0.2,0); c.Parent = b
            local s = Instance.new("UIStroke"); s.Thickness = 1; s.Color = Color3.fromRGB(80, 80, 90); s.Name = "BtnStroke"; s.Parent = b
            return b
        end

        espBtn = createExtraBtn("ESP", 0)
        nearBtn = createExtraBtn("é¢å‘æœ€è¿‘ç©å®¶", 30)
        clickBtn = createExtraBtn("é¢å‘é›™æ“Šç©å®¶", 60)

        -- å»¶ä¼¸æŒ‰éˆ•é‚è¼¯
        local extended = false
        extBtn.Activated:Connect(function()
            extended = not extended
            extBtn.Text = extended and "æ”¶å›" or "å»¶ä¼¸"
            extBtn.TextColor3 = Color3.new(1, 1, 1)
            Tw:Create(extFrame, TweenInfo.new(0.3), {Size = UDim2.fromOffset(64, extended and 90 or 0)}):Play()
        end)

        -- ä¸» ShiftLock æŒ‰éˆ•
        btn.Activated:Connect(function()
            if lockMode == "shiftlock" then 
                clearAllModesUI() 
            else 
                clearAllModesUI()
                lockMode = "shiftlock"
                shiftLockEnabled = true
                if UIS.MouseEnabled then
                    UIS.MouseBehavior = Enum.MouseBehavior.LockCenter
                end
                setFaceRotation("shiftlock")
                icn.Image = "rbxasset://textures/ui/mouseLock_on.png"
                Tw:Create(btn, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(38, 48, 60)}):Play()
            end
        end)

        -- é¢å‘æœ€è¿‘ç©å®¶
        nearBtn.Activated:Connect(function()
            if lockMode == "nearest" then 
                clearAllModesUI() 
            else 
                clearAllModesUI()
                lockMode = "nearest"
                updateButtonState(nearBtn, true)
                setFaceRotation("nearest")
            end
        end)

        -- é¢å‘é›™æ“Šç©å®¶
        clickBtn.Activated:Connect(function()
            if lockMode == "click" then 
                clearAllModesUI()
            else
                clearAllModesUI()
                lockMode = "click"
                updateButtonState(clickBtn, true)
                
                lockMouseClickConn = plr:GetMouse().Button1Down:Connect(function()
                    local mouse = plr:GetMouse()
                    local cam = Wk.CurrentCamera
                    local ray = cam:ScreenPointToRay(mouse.X, mouse.Y)
                    local foundPlayer = nil
                    local minDistance = math.huge
                    
                    for _, p in ipairs(Plrs:GetPlayers()) do
                        if p ~= plr and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
                            local hrp = p.Character.HumanoidRootPart
                            local rayToPlayer = hrp.Position - ray.Origin
                            local projection = rayToPlayer:Dot(ray.Direction.Unit)
                            if projection > 0 then
                                local closestPoint = ray.Origin + ray.Direction.Unit * projection
                                local distance = (hrp.Position - closestPoint).Magnitude
                                if distance < 8 and projection < minDistance then 
                                    minDistance = projection
                                    foundPlayer = p 
                                end
                            end
                        end
                    end
                    
                    if foundPlayer and foundPlayer ~= plr then
                        local now = tick()
                        if lastClickedPlayer == foundPlayer and (now - lastClickTime) < 0.5 then 
                            lockTargetPlayer = foundPlayer
                            setFaceRotation("click", foundPlayer)
                            
                            -- ã€æ–°å¢ã€‘å¦‚æœé˜²åç¹é–‹å•Ÿï¼Œå°‡æ­¤ç›®æ¨™è¨­ç‚ºé˜²åç¹çš„æ‰‹å‹•é–å®šç›®æ¨™
                            if toggles.counterEvade then
                                manualLockedTarget = foundPlayer
                                print("ğŸ¯ å·²å°‡ " .. foundPlayer.Name .. " è¨­ç‚ºé˜²åç¹ç›®æ¨™")
                            end
                        end
                        lastClickedPlayer = foundPlayer
                        lastClickTime = now
                    end
                end)
            end
        end)

        -- ESP åŠŸèƒ½
        local espEnabled = false
        local espLabels = {}
        local espBoxes = {}
        local espConn = nil

        local function cleanupESP(p)
            if espLabels[p] then
                if espLabels[p].billboard then espLabels[p].billboard:Destroy() end
                espLabels[p] = nil
            end
            if espBoxes[p] then
                espBoxes[p]:Destroy()
                espBoxes[p] = nil
            end
        end

        local function createESPBox(character)
            local box = Instance.new("BoxHandleAdornment")
            box.Name = "ESPBox"; box.AlwaysOnTop = true; box.ZIndex = 1
            box.Transparency = 0.7; box.Color3 = Color3.new(1, 1, 1); box.Parent = shiftLockUI
            return box
        end

        espBtn.Activated:Connect(function()
            espEnabled = not espEnabled
            updateButtonState(espBtn, espEnabled)
            
            if not espEnabled then
                if espConn then espConn:Disconnect(); espConn = nil end
                for p, _ in pairs(espLabels) do cleanupESP(p) end
                for p, _ in pairs(espBoxes) do cleanupESP(p) end
            else
                espConn = RS.RenderStepped:Connect(function()
                    local myChar = plr.Character
                    local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
                    
                    for _, p in ipairs(Plrs:GetPlayers()) do
                        if p ~= plr then
                            local char = p.Character
                            local hrp = char and char:FindFirstChild("HumanoidRootPart")
                            local hum = char and char:FindFirstChildOfClass("Humanoid")
                            if char and hrp and hum and hum.Health > 0 then
                                if not espLabels[p] then
                                    local bg = Instance.new("BillboardGui")
                                    bg.Size = UDim2.fromOffset(200, 50); bg.AlwaysOnTop = true
                                    bg.StudsOffset = Vector3.new(0, 3, 0); bg.Parent = shiftLockUI
                                    local tl = Instance.new("TextLabel")
                                    tl.Size = UDim2.fromScale(1, 1); tl.BackgroundTransparency = 1
                                    tl.TextColor3 = Color3.new(1, 1, 1); tl.TextStrokeTransparency = 0.5
                                    tl.TextSize = 14; tl.Font = Enum.Font.SourceSansBold; tl.Parent = bg
                                    espLabels[p] = {billboard = bg, label = tl}
                                end
                                if not espBoxes[p] then espBoxes[p] = createESPBox(char) end
                                local dist = myHRP and (myHRP.Position - hrp.Position).Magnitude or 0
                                local lab = espLabels[p]
                                lab.billboard.Adornee = hrp
                                lab.label.Text = string.format("å: %s\nè¡€é‡: %.0f/%.0f\nè·é›¢: %.1f", p.Name, hum.Health, hum.MaxHealth, dist)
                                local box = espBoxes[p]; box.Adornee = char; box.Size = char:GetExtentsSize()
                            else cleanupESP(p) end
                        end
                    end
                    for p, _ in pairs(espLabels) do if not Plrs:FindFirstChild(p.Name) then cleanupESP(p) end end
                end)
            end
        end)

        -- æ‹–æ›³åŠŸèƒ½
        local dragging, dragInput, dragStart, startPos
        
        dragHandle.InputBegan:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                dragStart = input.Position
                startPos = btn.Position
                
                Tw:Create(dragHandle, TweenInfo.new(0.1), {BackgroundColor3 = Color3.fromRGB(150, 150, 160)}):Play()
                
                input.Changed:Connect(function()
                    if input.UserInputState == Enum.UserInputState.End then
                        dragging = false
                        Tw:Create(dragHandle, TweenInfo.new(0.2), {BackgroundColor3 = Color3.fromRGB(100, 100, 110)}):Play()
                    end
                end)
            end
        end)
        
        UIS.InputChanged:Connect(function(input)
            if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
                local delta = input.Position - dragStart
                btn.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
            end
        end)

        -- é—œé–‰æŒ‰éˆ•
        xBtn.Activated:Connect(function() 
            clearAllModesUI()
            if espConn then espConn:Disconnect() end
            for p, _ in pairs(espLabels) do cleanupESP(p) end
            for p, _ in pairs(espBoxes) do cleanupESP(p) end
            shiftLockUI:Destroy()
        end)
        
        plr.CharacterAdded:Connect(function()
            task.wait(0.5)
            if lockMode ~= "none" then setFaceRotation(lockMode, lockTargetPlayer) end
        end)

        -- åˆå§‹åŒ–ï¼šé è¨­é–‹å•Ÿ ESPï¼Œé—œé–‰é–å®š
        task.wait(0.1)
        
        -- å•Ÿå‹• ESP
        espEnabled = true
        updateButtonState(espBtn, true)
        espConn = RS.RenderStepped:Connect(function()
            local myChar = plr.Character
            local myHRP = myChar and myChar:FindFirstChild("HumanoidRootPart")
            
            for _, p in ipairs(Plrs:GetPlayers()) do
                if p ~= plr then
                    local char = p.Character
                    local hrp = char and char:FindFirstChild("HumanoidRootPart")
                    local hum = char and char:FindFirstChildOfClass("Humanoid")
                    if char and hrp and hum and hum.Health > 0 then
                        if not espLabels[p] then
                            local bg = Instance.new("BillboardGui")
                            bg.Size = UDim2.fromOffset(200, 50); bg.AlwaysOnTop = true
                            bg.StudsOffset = Vector3.new(0, 3, 0); bg.Parent = shiftLockUI
                            local tl = Instance.new("TextLabel")
                            tl.Size = UDim2.fromScale(1, 1); tl.BackgroundTransparency = 1
                            tl.TextColor3 = Color3.new(1, 1, 1); tl.TextStrokeTransparency = 0.5
                            tl.TextSize = 14; tl.Font = Enum.Font.SourceSansBold; tl.Parent = bg
                            espLabels[p] = {billboard = bg, label = tl}
                        end
                        if not espBoxes[p] then espBoxes[p] = createESPBox(char) end
                        local dist = myHRP and (myHRP.Position - hrp.Position).Magnitude or 0
                        local lab = espLabels[p]
                        lab.billboard.Adornee = hrp
                        lab.label.Text = string.format("å: %s\nè¡€é‡: %.0f/%.0f\nè·é›¢: %.1f", p.Name, hum.Health, hum.MaxHealth, dist)
                        local box = espBoxes[p]; box.Adornee = char; box.Size = char:GetExtentsSize()
                    else cleanupESP(p) end
                end
            end
            for p, _ in pairs(espLabels) do if not Plrs:FindFirstChild(p.Name) then cleanupESP(p) end end
        end)

        print("âœ… ShiftLock + ESP ç³»çµ±å·²æ•´åˆï¼ˆé è¨­å•Ÿå‹• ESPï¼Œé–å®šé—œé–‰ï¼‰")
    end)
end)
